(function(){"use strict";var i=(o=>(o.PLATFORM_DETECTION_TIMEOUT="FAF_1001",o.PLATFORM_DETECTION_FAILED="FAF_1002",o.PLATFORM_NOT_SUPPORTED="FAF_1003",o.PLATFORM_DOM_ACCESS_DENIED="FAF_1004",o.EXTRACTION_TIMEOUT="FAF_1101",o.EXTRACTION_FAILED="FAF_1102",o.EXTRACTION_INVALID_DATA="FAF_1103",o.EXTRACTION_PERMISSION_DENIED="FAF_1104",o.EXTRACTION_RATE_LIMITED="FAF_1105",o.CHROME_TAB_ACCESS_DENIED="FAF_1201",o.CHROME_STORAGE_QUOTA_EXCEEDED="FAF_1202",o.CHROME_MESSAGING_FAILED="FAF_1203",o.CHROME_PERMISSIONS_MISSING="FAF_1204",o.CHROME_RUNTIME_ERROR="FAF_1205",o.CHROME_TAB_NOT_FOUND="FAF_1206",o.CHROME_API_UNAVAILABLE="FAF_1207",o.CHROME_MESSAGE_FAILED="FAF_1208",o.CHROME_SCRIPTING_FAILED="FAF_1209",o.CHROME_STORAGE_ERROR="FAF_1210",o.SERVICE_WORKER_INIT_FAILED="FAF_1301",o.SERVICE_WORKER_MESSAGE_FAILED="FAF_1302",o.SERVICE_WORKER_MEMORY_PRESSURE="FAF_1303",o.SERVICE_WORKER_TIMEOUT="FAF_1304",o.POPUP_LOAD_FAILED="FAF_1401",o.POPUP_ACTION_FAILED="FAF_1402",o.POPUP_DATA_CORRUPT="FAF_1403",o.CLIPBOARD_PERMISSION_DENIED="FAF_1501",o.CLIPBOARD_WRITE_FAILED="FAF_1502",o.CLIPBOARD_DATA_TOO_LARGE="FAF_1503",o.NETWORK_REQUEST_FAILED="FAF_1601",o.NETWORK_TIMEOUT="FAF_1602",o.NETWORK_RATE_LIMITED="FAF_1603",o.CONTENT_SCRIPT_INJECTION_FAILED="FAF_1701",o.CONTENT_SCRIPT_DOM_BLOCKED="FAF_1702",o.CONTENT_SCRIPT_CSP_VIOLATION="FAF_1703",o.UNKNOWN_ERROR="FAF_1901",o.SYSTEM_OVERLOAD="FAF_1902",o.CONFIGURATION_ERROR="FAF_1903",o.DEPENDENCY_ERROR="FAF_1904",o))(i||{}),l=(o=>(o.LOW="low",o.MEDIUM="medium",o.HIGH="high",o.CRITICAL="critical",o))(l||{}),y=(o=>(o.RETRY="retry",o.FALLBACK="fallback",o.GRACEFUL_DEGRADATION="degrade",o.USER_ACTION_REQUIRED="user",o.RESTART_REQUIRED="restart",o.NO_RECOVERY="none",o))(y||{});class a extends Error{code;severity;userMessage;technicalDetails;recoveryStrategy;recoveryActions;context;timestamp;constructor(e,t,r={}){super(t,{cause:r.cause}),this.name="FAFError",this.code=e,this.timestamp=Date.now();const s=T.getErrorInfo(e);this.severity=s.severity,this.recoveryStrategy=s.recoveryStrategy,this.recoveryActions=s.recoveryActions,this.userMessage=r.userMessage||s.userMessage,this.technicalDetails=r.technicalDetails,this.context={timestamp:this.timestamp,platform:r.context?.platform,url:r.context?.url||(typeof window<"u"?window.location.href:void 0),userAgent:r.context?.userAgent||(typeof navigator<"u"?navigator.userAgent:void 0),sessionId:r.context?.sessionId},this.trackError()}static fromUnknown(e,t){if(e instanceof a)return e;if(e instanceof Error){let s="FAF_1901";return e.message.includes("timeout")?s="FAF_1101":e.message.includes("permission")?s="FAF_1204":e.message.includes("DOM")||e.message.includes("document")?s="FAF_1004":e.message.includes("quota")&&(s="FAF_1202"),new a(s,e.message,{cause:e,technicalDetails:e.stack,context:t})}const r=typeof e=="string"?e:String(e);return new a("FAF_1901",r,{context:t})}isRecoverable(){return this.recoveryStrategy!=="none"}requiresUserAction(){return this.recoveryStrategy==="user"}getDisplayInfo(){return{title:this.getErrorTitle(),message:this.userMessage,actions:this.recoveryActions,severity:this.severity,canRetry:this.recoveryStrategy==="retry"}}toJSON(){return{code:this.code,severity:this.severity,message:this.message,userMessage:this.userMessage,technicalDetails:this.technicalDetails,recoveryStrategy:this.recoveryStrategy,recoveryActions:this.recoveryActions,context:this.context,timestamp:this.timestamp,stack:this.stack}}getErrorTitle(){return{low:"Minor Issue",medium:"Issue Detected",high:"Extraction Problem",critical:"Critical Error"}[this.severity]}trackError(){try{console.warn(`[FAF Error ${this.code}] ${this.severity}: ${this.message}`)}catch{}}}class T{static errorDefinitions=new Map([["FAF_1001",{code:"FAF_1001",severity:"medium",message:"Platform detection timed out",userMessage:"Unable to detect the current platform quickly enough. The page may be loading slowly.",recoveryStrategy:"retry",recoveryActions:["Wait for page to load completely","Refresh the page","Try extraction again"]}],["FAF_1003",{code:"FAF_1003",severity:"medium",message:"Platform is not supported",userMessage:"This website is not currently supported by FAF. We support GitHub, Monaco Editor, CodeMirror, and other development platforms.",recoveryStrategy:"degrade",recoveryActions:["Try on a supported platform","Copy code manually","Request platform support"]}],["FAF_1004",{code:"FAF_1004",severity:"high",message:"DOM access denied",userMessage:"Cannot access page content due to security restrictions. This may be due to strict Content Security Policy.",recoveryStrategy:"user",recoveryActions:["Refresh the page","Check browser security settings","Try on a different page"]}],["FAF_1101",{code:"FAF_1101",severity:"medium",message:"Context extraction timed out",userMessage:"Extraction took longer than expected. The page may have complex content or be loading slowly.",recoveryStrategy:"retry",recoveryActions:["Wait a moment and try again","Refresh the page","Check internet connection"]}],["FAF_1104",{code:"FAF_1104",severity:"high",message:"Permission denied for extraction",userMessage:"FAF does not have permission to access this page. Please check extension permissions.",recoveryStrategy:"user",recoveryActions:["Check extension permissions in browser settings","Reload the extension","Refresh the page"]}],["FAF_1201",{code:"FAF_1201",severity:"high",message:"Chrome tab access denied",userMessage:"Cannot access the current tab. Please ensure FAF has the necessary permissions.",recoveryStrategy:"user",recoveryActions:["Grant tab permissions to FAF","Reload the extension","Check browser security settings"]}],["FAF_1202",{code:"FAF_1202",severity:"medium",message:"Chrome storage quota exceeded",userMessage:"Extension storage is full. Some data may not be saved.",recoveryStrategy:"fallback",recoveryActions:["Clear extension data","Restart browser","Continue without saving preferences"]}],["FAF_1204",{code:"FAF_1204",severity:"critical",message:"Required Chrome permissions missing",userMessage:"FAF is missing required permissions to function properly.",recoveryStrategy:"user",recoveryActions:["Go to chrome://extensions/","Find FAF extension","Grant required permissions"]}],["FAF_1206",{code:"FAF_1206",severity:"medium",message:"No active tab found",userMessage:"No active tab detected. Please open a supported page.",recoveryStrategy:"user",recoveryActions:["Open a supported website","Refresh the current page","Try a different tab"]}],["FAF_1207",{code:"FAF_1207",severity:"high",message:"Chrome API unavailable",userMessage:"Chrome extension APIs are not available.",recoveryStrategy:"restart",recoveryActions:["Restart browser","Check Chrome version","Reinstall extension"]}],["FAF_1208",{code:"FAF_1208",severity:"medium",message:"Chrome message failed",userMessage:"Failed to communicate with the page. Please try again.",recoveryStrategy:"retry",recoveryActions:["Try again","Refresh the page","Check page permissions"]}],["FAF_1209",{code:"FAF_1209",severity:"high",message:"Script injection failed",userMessage:"Unable to inject required scripts into the page.",recoveryStrategy:"fallback",recoveryActions:["Refresh the page","Try a different page","Check site permissions"]}],["FAF_1210",{code:"FAF_1210",severity:"medium",message:"Chrome storage error",userMessage:"Unable to save data. Some features may not persist.",recoveryStrategy:"degrade",recoveryActions:["Continue without saving","Clear extension data","Restart browser"]}],["FAF_1301",{code:"FAF_1301",severity:"critical",message:"Service worker initialization failed",userMessage:"Extension background service failed to start. Please restart the browser.",recoveryStrategy:"restart",recoveryActions:["Restart browser","Reload extension","Check for browser updates"]}],["FAF_1303",{code:"FAF_1303",severity:"medium",message:"Service worker under memory pressure",userMessage:"Extension is using high memory. Performance may be affected.",recoveryStrategy:"degrade",recoveryActions:["Close unused tabs","Restart browser","Limit concurrent extractions"]}],["FAF_1501",{code:"FAF_1501",severity:"medium",message:"Clipboard permission denied",userMessage:"Cannot copy to clipboard automatically. You can copy the content manually.",recoveryStrategy:"fallback",recoveryActions:["Grant clipboard permission","Copy content manually","Use Ctrl+C to copy"]}],["FAF_1503",{code:"FAF_1503",severity:"low",message:"Clipboard data too large",userMessage:"The extracted content is too large for clipboard. Consider extracting smaller sections.",recoveryStrategy:"degrade",recoveryActions:["Extract smaller code sections","Copy parts manually","Save to file instead"]}],["FAF_1703",{code:"FAF_1703",severity:"high",message:"Content Security Policy violation",userMessage:"Page security settings prevent FAF from working. This is common on some secure sites.",recoveryStrategy:"degrade",recoveryActions:["Try on a different page","Use manual copy instead","Contact site administrator"]}],["FAF_1901",{code:"FAF_1901",severity:"medium",message:"An unexpected error occurred",userMessage:"Something unexpected happened. Please try again or restart the browser.",recoveryStrategy:"retry",recoveryActions:["Try the action again","Refresh the page","Restart browser if issues persist"]}]]);static getErrorInfo(e){const t=this.errorDefinitions.get(e);return t||{code:e,severity:"medium",message:"Unknown error",userMessage:"An unknown error occurred. Please try again.",recoveryStrategy:"retry",recoveryActions:["Try again","Restart extension"]}}static getAllErrorCodes(){return Array.from(this.errorDefinitions.keys())}}class w{static async getActive(){return new Promise((e,t)=>{try{chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError){t(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome tabs API operation failed"}));return}const s=r[0];if(!s?.id||!s.url){t(new a(i.CHROME_TAB_NOT_FOUND,"No active tab found",{technicalDetails:"Chrome tabs API operation failed"}));return}e({id:s.id,url:s.url,title:s.title??"",active:s.active})})}catch(r){t(new a(i.CHROME_API_UNAVAILABLE,r instanceof Error?r.message:"Unknown tabs API error",{technicalDetails:"Chrome API operation failed"}))}})}static async sendMessage(e,t){return new Promise(r=>{try{chrome.tabs.sendMessage(e,t,s=>{if(chrome.runtime.lastError){console.warn("FAF: Tab messaging warning (non-blocking):",chrome.runtime.lastError.message),r();return}r()})}catch(s){console.warn("FAF: Tab messaging warning (non-blocking):",s),r()}})}static async executeScript(e,t){return new Promise(r=>{try{chrome.scripting.executeScript({target:{tabId:e},files:[...t]},()=>{if(chrome.runtime.lastError){console.warn("FAF: Script execution warning (non-blocking):",chrome.runtime.lastError.message),r();return}r()})}catch(s){console.warn("FAF: Script execution warning (non-blocking):",s),r()}})}}class v{static async get(e){return new Promise((t,r)=>{try{chrome.storage.local.get([...e],s=>{if(chrome.runtime.lastError){r(new a(i.CHROME_STORAGE_ERROR,chrome.runtime.lastError.message||"Unknown storage error",{technicalDetails:"Chrome API operation failed"}));return}t(s)})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown storage error",{technicalDetails:"Chrome API operation failed"}))}})}static async set(e){return new Promise((t,r)=>{try{chrome.storage.local.set(e,()=>{if(chrome.runtime.lastError){r(new a(i.CHROME_STORAGE_QUOTA_EXCEEDED,chrome.runtime.lastError.message||"Unknown storage error",{technicalDetails:"Chrome API operation failed"}));return}t()})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown storage error",{technicalDetails:"Chrome API operation failed"}))}})}static async clear(){return new Promise((e,t)=>{try{chrome.storage.local.clear(()=>{if(chrome.runtime.lastError){t(new a(i.CHROME_STORAGE_ERROR,chrome.runtime.lastError.message||"Unknown storage error",{technicalDetails:"Chrome API operation failed"}));return}e()})}catch(r){t(new a(i.CHROME_API_UNAVAILABLE,r instanceof Error?r.message:"Unknown storage error",{technicalDetails:"Chrome API operation failed"}))}})}}class g{static async setBadgeText(e){return new Promise((t,r)=>{try{chrome.action.setBadgeText({text:e},()=>{if(chrome.runtime.lastError){r(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}t()})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown action error",{technicalDetails:"Chrome API operation failed"}))}})}static async setBadgeBackgroundColor(e){return new Promise((t,r)=>{try{chrome.action.setBadgeBackgroundColor({color:e},()=>{if(chrome.runtime.lastError){r(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}t()})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown action error",{technicalDetails:"Chrome API operation failed"}))}})}static async updateBadge(e){const t=e,r=`${t}%`;let s;t>=80?s="#FF6B35":t>=50?s="#5CE1E6":s="#0A0A0A",await Promise.all([g.setBadgeText(r),g.setBadgeBackgroundColor(s)])}}class A{static async create(e,t,r="icon128.png"){return new Promise((s,n)=>{try{chrome.notifications.create({type:"basic",iconUrl:r,title:e,message:t,priority:2},()=>{if(chrome.runtime.lastError){n(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}s()})}catch(c){n(new a(i.CHROME_API_UNAVAILABLE,c instanceof Error?c.message:"Unknown notification error",{technicalDetails:"Chrome API operation failed"}))}})}}class R{static sendMessage(e){return new Promise(t=>{try{chrome.runtime.sendMessage(e,r=>{if(chrome.runtime.lastError){const s=chrome.runtime.lastError.message||"Unknown runtime error";if(s.includes("Could not establish connection")||s.includes("No such extension")||s.includes("Extension context invalidated")||s.includes("Receiving end does not exist")){t();return}console.warn("FAF: Runtime warning (non-blocking):",s),t();return}t()})}catch(r){console.warn("FAF: Messaging warning (non-blocking):",r),t()}})}static onMessage(e){chrome.runtime.onMessage.addListener(e)}static onInstalled(e){chrome.runtime.onInstalled.addListener(e)}}class I{static onCommand(e){chrome.commands.onCommand.addListener(e)}}class C{config;sessionId;breadcrumbs=[];performanceBuffer=[];userId;constructor(e){this.config=e,this.sessionId=this.generateSessionId(),this.initializeErrorHandling(),this.initializePerformanceTracking(),this.startPerformanceReporting()}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}initializeErrorHandling(){this.config.enableErrorReporting&&typeof window<"u"&&(window.addEventListener("error",e=>{this.reportError(new Error(e.message),{action:"global_error",url:e.filename,line:e.lineno,column:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.reportError(new Error(`Unhandled Promise Rejection: ${e.reason}`),{action:"unhandled_promise_rejection"})}))}initializePerformanceTracking(){this.config.enablePerformanceTracking&&(typeof window<"u"&&typeof performance<"u"&&performance.timing&&window.addEventListener("load",()=>{setTimeout(()=>{this.trackPerformanceMetrics()},1e3)}),this.trackExtensionMetrics())}trackExtensionMetrics(){if(chrome?.runtime){const e=performance.now();chrome.runtime.connect({name:"telemetry"});const t=performance.now()-e;this.recordMetric({name:"service_worker_connection_time",value:t,unit:"ms",timestamp:Date.now()})}if(typeof document<"u"&&document.readyState==="loading"){const e=performance.now();document.addEventListener("DOMContentLoaded",()=>{const t=performance.now()-e;this.recordMetric({name:"content_script_injection_time",value:t,unit:"ms",timestamp:Date.now()})})}}trackPerformanceMetrics(){const e=performance.timing,t=performance.navigation;if([{name:"dom_content_loaded",value:e.domContentLoadedEventEnd-e.navigationStart,unit:"ms"},{name:"page_load_complete",value:e.loadEventEnd-e.navigationStart,unit:"ms"},{name:"dns_lookup_time",value:e.domainLookupEnd-e.domainLookupStart,unit:"ms"},{name:"tcp_connection_time",value:e.connectEnd-e.connectStart,unit:"ms"}].forEach(s=>{s.value>0&&this.recordMetric({...s,timestamp:Date.now(),metadata:{navigationType:t.type,redirectCount:t.redirectCount}})}),performance.memory){const s=performance.memory;this.recordMetric({name:"memory_used",value:s.usedJSHeapSize,unit:"bytes",timestamp:Date.now()}),this.recordMetric({name:"memory_limit",value:s.jsHeapSizeLimit,unit:"bytes",timestamp:Date.now()})}}startPerformanceReporting(){setInterval(()=>{this.performanceBuffer.length>0&&this.flushPerformanceMetrics()},3e4)}async recordMetric(e){if(this.config.enablePerformanceTracking&&!(Math.random()>this.config.sampleRate)){this.performanceBuffer.push(e);try{const r=(await chrome.storage.local.get("telemetry_metrics")).telemetry_metrics||[];r.push(e),r.length>100&&r.shift(),await chrome.storage.local.set({telemetry_metrics:r})}catch(t){console.warn("Failed to store telemetry metric:",t)}}}async reportError(e,t={}){if(!this.config.enableErrorReporting)return;const r={error:{name:e.name,message:e.message,stack:e.stack||""},context:{userAgent:navigator.userAgent,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,extensionVersion:this.getExtensionVersion(),...t},stackTrace:e.stack||"",breadcrumbs:[...this.breadcrumbs]};try{const n=(await chrome.storage.local.get("telemetry_errors")).telemetry_errors||[];n.push(r),n.length>50&&n.shift(),await chrome.storage.local.set({telemetry_errors:n})}catch(s){console.warn("Failed to store error report:",s)}this.sendErrorReport(r)}async trackUserEvent(e,t={}){if(!this.config.enableUserAnalytics)return;const r={event:e,properties:{...t,extensionVersion:this.getExtensionVersion(),environment:this.config.environment},timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId};try{const n=(await chrome.storage.local.get("telemetry_events")).telemetry_events||[];n.push(r),n.length>200&&n.shift(),await chrome.storage.local.set({telemetry_events:n})}catch(s){console.warn("Failed to store user event:",s)}this.sendUserEvent(r)}async trackExtraction(e,t={}){return this.trackUserEvent(`extraction_${e}`,t)}async track(e,t={}){return this.trackUserEvent(e,t)}addBreadcrumb(e){const t=`${new Date().toISOString()}: ${e}`;this.breadcrumbs.push(t),this.breadcrumbs.length>20&&this.breadcrumbs.shift()}setUserId(e){this.userId=e}async flushPerformanceMetrics(){if(this.performanceBuffer.length===0)return;const e=[...this.performanceBuffer];this.performanceBuffer=[];try{await this.sendBatch("metrics",e)}catch(t){console.warn("Failed to send performance metrics:",t),this.performanceBuffer.unshift(...e)}}async sendErrorReport(e){try{await this.sendBatch("errors",[e])}catch(t){console.warn("Failed to send error report:",t)}}async sendUserEvent(e){try{await this.sendBatch("events",[e])}catch(t){console.warn("Failed to send user event:",t)}}async sendBatch(e,t){if(!this.config.endpoint)return;const r={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,environment:this.config.environment},s=await fetch(`${this.config.endpoint}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`)}getExtensionVersion(){try{return chrome.runtime.getManifest().version}catch{return"unknown"}}startTimer(e){const t=performance.now();return()=>{const r=performance.now()-t;this.recordMetric({name:e,value:r,unit:"ms",timestamp:Date.now()})}}trackMemoryUsage(e){if(performance.memory){const t=performance.memory;this.recordMetric({name:"memory_usage_snapshot",value:t.usedJSHeapSize,unit:"bytes",timestamp:Date.now(),metadata:{context:e}})}}trackNetworkRequest(e,t,r,s){this.recordMetric({name:"network_request",value:r,unit:"ms",timestamp:Date.now(),metadata:{url:e.replace(/[?#].*/,""),method:t,status:s,success:s>=200&&s<400}})}}const u=(()=>{const o=typeof process<"u"&&process.env?.NODE_ENV||"production",e=typeof process<"u"&&process.env?.TELEMETRY_ENDPOINT||void 0,t=o==="development",r=o==="production",s={environment:t?"development":r?"production":"staging",enableErrorReporting:r,enablePerformanceTracking:!0,enableUserAnalytics:r,sampleRate:t?1:.1,endpoint:e};return new C(s)})(),O={maxAttempts:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2,timeout:3e4};class p{static instance=null;retryAttempts=new Map;retryTimers=new Map;static getInstance(){return p.instance||(p.instance=new p),p.instance}async withRecovery(e,t){const{operationId:r,context:s="unknown"}=t,n={...O,...t.retryConfig};let c=null;const _=Date.now();this.clearRetryTimer(r);for(let m=1;m<=n.maxAttempts;m++)try{if(n.timeout&&Date.now()-_>n.timeout)throw new a(i.EXTRACTION_TIMEOUT,"Operation timeout exceeded",{context:{timestamp:Date.now()}});const f=await this.executeWithTimeout(e,n.timeout);return this.retryAttempts.delete(r),m>1&&u.track("error_boundary",{type:"recovery_success",operationId:r,context:s,attemptsRequired:m,duration:Date.now()-_}),f}catch(f){if(c=f instanceof a?f:a.fromUnknown(f,{timestamp:Date.now()}),console.warn(`[${s}] Attempt ${m}/${n.maxAttempts} failed:`,{error:c.code,message:c.message,severity:c.severity}),this.retryAttempts.set(r,m),!this.shouldRetry(c,m,n.maxAttempts))break;const b=this.calculateDelay(m,n);m<n.maxAttempts&&await this.delay(b)}if(t.fallbackOperation)try{console.log(`[${s}] Trying fallback operation after ${n.maxAttempts} failed attempts`);const m=await t.fallbackOperation();return u.track("error_boundary",{type:"fallback_success",operationId:r,context:s,originalError:c?.code,duration:Date.now()-_}),m}catch(m){const f=m instanceof a?m:a.fromUnknown(m,{timestamp:Date.now()});if(u.track("error_boundary",{type:"fallback_failed",operationId:r,context:s,originalError:c?.code,fallbackError:f.code,duration:Date.now()-_}),this.compareSeverity(f.severity,c?.severity||l.LOW)>=0)throw f}throw this.retryAttempts.delete(r),u.track("error_boundary",{type:"recovery_failed",operationId:r,context:s,finalError:c?.code,attemptsUsed:n.maxAttempts,duration:Date.now()-_}),c||new a(i.UNKNOWN_ERROR,"Operation failed after all recovery attempts")}async handleError(e,t){const r=e instanceof a?e:a.fromUnknown(e);switch(u.track("error_boundary",{type:"error_handled",operationId:t.operationId,operationType:t.operationType,errorCode:r.code,severity:r.severity,recoveryStrategy:r.recoveryStrategy}),r.recoveryStrategy){case y.RETRY:return{recovered:!1,suggestion:"This issue is usually temporary. Try the operation again.",actions:["Retry now","Wait 30 seconds and retry","Refresh page and retry"]};case y.FALLBACK:return{recovered:await this.attemptFallbackRecovery(r,t),suggestion:"Switched to alternative method due to the issue.",actions:["Continue with limited functionality","Try full operation later","Check settings"]};case y.GRACEFUL_DEGRADATION:return{recovered:!0,suggestion:"Continuing with reduced functionality to work around the issue.",actions:["Continue anyway","Try on different page","Report issue"]};case y.USER_ACTION_REQUIRED:return{recovered:!1,suggestion:"User action is required to resolve this issue.",actions:r.recoveryActions};case y.RESTART_REQUIRED:return{recovered:!1,suggestion:"Extension restart is required to fix this issue.",actions:["Restart browser","Reload extension","Check for updates"]};default:return{recovered:!1,suggestion:"This error requires manual resolution.",actions:["Try again later","Check browser console","Report issue"]}}}getRetryCount(e){return this.retryAttempts.get(e)||0}clearRetryState(e){this.retryAttempts.delete(e),this.clearRetryTimer(e)}getRecoveryRecommendations(e){const t=e instanceof a?e:a.fromUnknown(e);switch(this.categorizeError(t.code)){case"platform":return{immediate:["Refresh the page","Wait for page to fully load","Try on supported platform"],followUp:["Check internet connection","Clear browser cache","Update browser"],prevention:["Use supported development platforms","Ensure stable internet connection"]};case"permissions":return{immediate:["Check extension permissions","Grant required permissions","Reload extension"],followUp:["Restart browser","Reinstall extension if needed"],prevention:["Keep extension permissions up to date","Avoid revoking permissions"]};case"performance":return{immediate:["Close unused tabs","Wait and retry","Reduce complexity"],followUp:["Restart browser","Check system resources"],prevention:["Limit concurrent operations","Use smaller code sections"]};case"network":return{immediate:["Check internet connection","Retry in a moment","Try different network"],followUp:["Clear browser cache","Disable VPN if used"],prevention:["Use stable internet connection","Avoid peak usage times"]};default:return{immediate:t.recoveryActions,followUp:["Restart browser","Check for updates"],prevention:["Keep extension updated","Use supported browsers"]}}}async executeWithTimeout(e,t){return t?Promise.race([e(),new Promise((r,s)=>{setTimeout(()=>{s(new a(i.EXTRACTION_TIMEOUT,`Operation timed out after ${t}ms`))},t)})]):e()}shouldRetry(e,t,r){return t>=r||e.severity===l.CRITICAL||e.recoveryStrategy===y.USER_ACTION_REQUIRED||e.recoveryStrategy===y.NO_RECOVERY?!1:![i.CHROME_PERMISSIONS_MISSING,i.PLATFORM_NOT_SUPPORTED,i.CONTENT_SCRIPT_CSP_VIOLATION].includes(e.code)}calculateDelay(e,t){const r=t.baseDelay*Math.pow(t.backoffFactor,e-1),s=Math.random()*.1*r;return Math.min(r+s,t.maxDelay)}async delay(e){return new Promise(t=>setTimeout(t,e))}clearRetryTimer(e){const t=this.retryTimers.get(e);t&&(clearTimeout(t),this.retryTimers.delete(e))}compareSeverity(e,t){const r=[l.LOW,l.MEDIUM,l.HIGH,l.CRITICAL];return r.indexOf(e)-r.indexOf(t)}async attemptFallbackRecovery(e,t){switch(e.code){case i.CLIPBOARD_PERMISSION_DENIED:return!0;case i.PLATFORM_DOM_ACCESS_DENIED:return!1;case i.CHROME_STORAGE_QUOTA_EXCEEDED:try{return!0}catch{return!1}default:return!1}}categorizeError(e){return e.includes("PLATFORM")?"platform":e.includes("PERMISSION")||e.includes("ACCESS")?"permissions":e.includes("TIMEOUT")||e.includes("MEMORY")||e.includes("QUOTA")?"performance":e.includes("NETWORK")||e.includes("REQUEST")?"network":"unknown"}}const S=p.getInstance(),M={showNotification:!0,showInPopup:!1,showInConsole:!0,autoRetry:!1,retryDelay:5e3};class E{static instance=null;activeNotifications=new Set;userDismissals=new Set;static getInstance(){return E.instance||(E.instance=new E),E.instance}async showError(e,t,r=M){const s=e instanceof a?e:a.fromUnknown(e),n=s.getDisplayInfo(),c=`${t.operationId}_${s.code}`;if(!this.userDismissals.has(s.code)&&!this.activeNotifications.has(c)){this.activeNotifications.add(c);try{r.showNotification&&this.shouldShowNotification(s)&&await this.showBrowserNotification(s,n,t),r.showInConsole&&this.showConsoleError(s,n,t),r.autoRetry&&n.canRetry&&t.retryOperation&&await this.handleAutoRetry(s,t,r),u.track("error_boundary",{type:"error_notification_shown",errorCode:s.code,severity:s.severity,operationId:t.operationId,operationType:t.operationType,notificationMethod:this.getNotificationMethods(r)})}finally{setTimeout(()=>{this.activeNotifications.delete(c)},3e4)}}}async showRecoverySuccess(e,t="Issue resolved successfully!"){try{await A.create("FAF - Recovered ‚úÖ",t,"icons/success-128.png"),u.track("error_boundary",{type:"recovery_success_notification",operationId:e,message:t})}catch(r){console.warn("Failed to show recovery success notification:",r)}}displayInPopup(e){const t=e instanceof a?e:a.fromUnknown(e),r=t.getDisplayInfo(),s=S.getRecoveryRecommendations(t);return{title:r.title,message:r.message,severity:r.severity,canRetry:r.canRetry,actions:this.createErrorActions(t,s)}}dismissErrorType(e){this.userDismissals.add(e),setTimeout(()=>{this.userDismissals.delete(e)},36e5),u.track("user_action",{action:"error_dismissed",errorCode:e})}clearAll(){this.activeNotifications.clear(),this.userDismissals.clear()}getNotificationState(){return{activeCount:this.activeNotifications.size,dismissedCount:this.userDismissals.size,activeNotifications:Array.from(this.activeNotifications)}}shouldShowNotification(e){return e.severity===l.LOW?!1:!["FAF_1003","FAF_1503"].includes(e.code)}async showBrowserNotification(e,t,r){try{const s=this.getNotificationIcon(e.severity),n=`FAF - ${t.title}`,c=t.message.length>100?`${t.message.substring(0,97)}...`:t.message;await A.create(n,c,s)}catch(s){console.warn("Failed to show browser notification:",s)}}showConsoleError(e,t,r){const s=this.getConsoleMethod(e.severity),n=`[FAF ${r.operationType}]`;s(`${n} ${e.code}: ${e.message}`,{userMessage:t.message,severity:e.severity,recoveryActions:t.actions,context:e.context,operationId:r.operationId})}async handleAutoRetry(e,t,r){if(!(!t.retryOperation||!r.retryDelay)){await new Promise(s=>setTimeout(s,r.retryDelay));try{console.log(`[FAF Auto-Retry] Attempting to retry ${t.operationId}...`),await t.retryOperation(),await this.showRecoverySuccess(t.operationId,"Auto-retry successful!")}catch(s){console.warn(`[FAF Auto-Retry] Retry failed for ${t.operationId}:`,s)}}}createErrorActions(e,t){const r=[];return t.immediate.forEach((s,n)=>{r.push({id:`immediate_${n}`,label:s,type:"primary",priority:"high"})}),t.followUp.slice(0,2).forEach((s,n)=>{r.push({id:`followup_${n}`,label:s,type:"secondary",priority:"medium"})}),r.push({id:"dismiss",label:"Dismiss",type:"secondary",priority:"low"}),r}getNotificationIcon(e){return{[l.LOW]:"icons/info-128.png",[l.MEDIUM]:"icons/warning-128.png",[l.HIGH]:"icons/error-128.png",[l.CRITICAL]:"icons/critical-128.png"}[e]||"icons/warning-128.png"}getConsoleMethod(e){switch(e){case l.LOW:return console.info;case l.MEDIUM:return console.warn;case l.HIGH:case l.CRITICAL:return console.error;default:return console.log}}getNotificationMethods(e){const t=[];return e.showNotification&&t.push("browser_notification"),e.showInPopup&&t.push("popup"),e.showInConsole&&t.push("console"),t}}const F=E.getInstance();class x{activeExtractions=new Map;stats={totalExtractions:0,successfulExtractions:0,failedExtractions:0,lastExtraction:null,lastError:null};MAX_ACTIVE_EXTRACTIONS=10;MAX_EXTRACTION_AGE_MS=3e5;CLEANUP_INTERVAL_MS=6e4;cleanupTimer=null;constructor(){this.startPeriodicCleanup()}addActiveExtraction(e,t){this.clearActiveExtraction(e),this.activeExtractions.size>=this.MAX_ACTIVE_EXTRACTIONS&&this.cleanupOldestExtractions(1);const r=setTimeout(()=>{this.handleExtractionTimeout(e)},t);this.activeExtractions.set(e,{tabId:e,startTime:Date.now(),timeout:r})}clearActiveExtraction(e){const t=this.activeExtractions.get(e);return t?(clearTimeout(t.timeout),this.activeExtractions.delete(e),!0):!1}isExtractionActive(e){return this.activeExtractions.has(e)}getActiveExtractionCount(){return this.activeExtractions.size}recordSuccess(e){this.stats.totalExtractions++,this.stats.successfulExtractions++,this.stats.lastExtraction=e,this.stats.lastError=null,e.success&&e.faf&&u.trackExtraction("complete",{platform:e.faf.context.platform,score:e.faf.score,duration:e.faf.context.metadata.extractionTime,fileCount:e.faf.context.structure.totalFiles})}recordFailure(e){this.stats.totalExtractions++,this.stats.failedExtractions++,this.stats.lastError=e,u.trackExtraction("error",{error:e})}getStats(){return{...this.stats}}async handleExtractionTimeout(e){this.clearActiveExtraction(e);const t=new a(i.EXTRACTION_TIMEOUT,`Extraction timeout for tab ${e}`,{context:{timestamp:Date.now()}});this.recordFailure(t.userMessage),await F.showError(t,{operationId:`extraction_${e}`,operationType:"context_extraction",retryOperation:async()=>{const r={type:"EXTRACT_CONTEXT",timestamp:Date.now(),source:"service-worker"};await w.sendMessage(e,r)}})}startPeriodicCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.cleanupTimer=setInterval(()=>{this.performCleanup()},this.CLEANUP_INTERVAL_MS),this.performCleanup()}performCleanup(){const e=Date.now();let t=0;for(const[r,s]of this.activeExtractions.entries())e-s.startTime>this.MAX_EXTRACTION_AGE_MS&&(this.clearActiveExtraction(r),t++);if(this.activeExtractions.size>this.MAX_ACTIVE_EXTRACTIONS){const r=this.activeExtractions.size-this.MAX_ACTIVE_EXTRACTIONS;this.cleanupOldestExtractions(r),t+=r}this.cleanupStatsMemory(),t>0&&console.log(`üßπ Service Worker cleanup: removed ${t} old extractions`)}cleanupOldestExtractions(e){const t=Array.from(this.activeExtractions.entries()).sort(([,r],[,s])=>r.startTime-s.startTime);for(let r=0;r<Math.min(e,t.length);r++){const s=t[r];if(s){const[n]=s;this.clearActiveExtraction(n)}}}cleanupStatsMemory(){this.stats.lastExtraction&&(this.stats.lastExtraction=null,this.stats.lastError=this.stats.lastError?.substring(0,100)||null)}destroy(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null);for(const[e]of this.activeExtractions.entries())this.clearActiveExtraction(e);this.activeExtractions.clear()}getMemoryStats(){const e=this.activeExtractions.size,t=this.stats.totalExtractions;let r="low";return e>this.MAX_ACTIVE_EXTRACTIONS*.8?r="high":e>this.MAX_ACTIVE_EXTRACTIONS*.5&&(r="medium"),{activeExtractions:e,totalStats:t,memoryPressure:r}}}class d extends Error{constructor(e,t){super(e),this.code=t,this.name="ServiceWorkerError"}}class k{state=new x;EXTRACTION_TIMEOUT=3e4;MAX_CONCURRENT_EXTRACTIONS=3;constructor(){this.initialize()}initialize(){try{u.track("user_action",{action:"service_worker_start",timestamp:Date.now()}),this.setupMessageHandling(),this.setupInstallationHandling(),this.setupCommandHandling(),this.setupBadgeInitialization(),console.log("üèéÔ∏è FAF Service Worker initialized successfully")}catch(e){throw u.track("error_boundary",{type:"service_worker_init_failure",error:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:"No stack trace"}),console.error("‚ùå Service Worker initialization failed:",e),new a(i.SERVICE_WORKER_INIT_FAILED,`Service worker initialization failed: ${e instanceof Error?e.message:"Unknown error"}`,{context:{timestamp:Date.now()}})}}setupMessageHandling(){R.onMessage((e,t,r)=>(this.handleMessage(e,t,r).then(s=>{s!==void 0&&r(s)}).catch(s=>{const n=s instanceof a?s:new a(i.SERVICE_WORKER_MESSAGE_FAILED,"Service worker message handling failed",{context:{messageType:e.type,timestamp:Date.now()}});console.error("Message handling error:",n),u.track("error_boundary",{type:"service_worker_message_error",errorCode:n.code,messageType:e.type,severity:n.severity}),r({success:!1,error:n.userMessage,code:n.code})}),!0))}setupInstallationHandling(){R.onInstalled(()=>{this.initializeBadge().then(()=>{console.log("‚úÖ FAF Extension installed and badge initialized")}).catch(e=>{console.error("‚ùå Badge initialization failed:",e)})})}setupCommandHandling(){I.onCommand(e=>{e==="extract-context"&&this.handleKeyboardShortcut().catch(t=>{console.error("‚ùå Keyboard shortcut failed:",t)})})}async initializeBadge(){try{await g.setBadgeBackgroundColor("#FF6B35"),await g.setBadgeText("FAF")}catch(e){throw new d(`Badge initialization failed: ${e instanceof Error?e.message:"Unknown error"}`,"MESSAGING_ERROR")}}setupBadgeInitialization(){this.initializeBadge().catch(e=>{console.error("‚ùå Initial badge setup failed:",e)})}async handleMessage(e,t,r){if(!this.isValidMessage(e))throw new d("Invalid message format","MESSAGING_ERROR");const s=t.tab?.id;if(s===void 0)throw new d("Message sender has no tab ID","TAB_ERROR");console.log(`üì® Received message: ${e.type} from tab ${s}`),u.track("api_call",{type:"message_received",messageType:e.type,tabId:s,timestamp:Date.now()});try{switch(e.type){case"EXTRACT_CONTEXT":return await this.handleExtractRequest(e,s);case"CONTEXT_EXTRACTED":return await this.handleContextExtracted(e,s);case"ERROR":return await this.handleError(e,s);default:throw new d(`Unknown message type: ${e.type}`,"MESSAGING_ERROR")}}catch(n){const c=n instanceof Error?n.message:"Unknown error";throw u.track("error_boundary",{type:"message_handling_error",messageType:e.type,error:c,tabId:s}),console.error(`‚ùå Message handling failed for ${e.type}:`,c),this.state.recordFailure(c),n}}async handleExtractRequest(e,t){if(this.state.getActiveExtractionCount()>=this.MAX_CONCURRENT_EXTRACTIONS)throw new d(`Too many concurrent extractions (max: ${this.MAX_CONCURRENT_EXTRACTIONS})`,"EXTRACTION_ERROR");if(this.state.isExtractionActive(t))throw new d(`Extraction already in progress for tab ${t}`,"EXTRACTION_ERROR");try{return this.state.addActiveExtraction(t,this.EXTRACTION_TIMEOUT),await w.sendMessage(t,e),console.log(`üöÄ Extraction started for tab ${t}`),{success:!0}}catch(r){throw this.state.clearActiveExtraction(t),r instanceof a?new a(i.SERVICE_WORKER_MESSAGE_FAILED,`Tab communication failed: ${r.message}`,{context:{timestamp:Date.now()}}):new d(`Extraction request failed: ${r instanceof Error?r.message:"Unknown error"}`,"EXTRACTION_ERROR")}}async handleContextExtracted(e,t){this.state.clearActiveExtraction(t)||console.warn(`‚ö†Ô∏è Received extraction result for inactive tab ${t}`);const s=e.payload;if(!s.success)throw this.state.recordFailure(s.error),new d(`Extraction failed: ${s.error}`,"EXTRACTION_ERROR");try{return this.state.recordSuccess(s),await this.updateBadgeWithScore(s.faf.score),await v.set({lastExtraction:s,timestamp:Date.now()}),await this.showSuccessNotification(s.faf.score,s.faf.context.metadata.extractionTime),console.log(`‚úÖ Extraction completed for tab ${t} with score ${s.faf.score}%`),{success:!0}}catch(n){throw console.error("‚ùå Post-extraction processing failed:",n),new d(`Post-extraction processing failed: ${n instanceof Error?n.message:"Unknown error"}`,"STORAGE_ERROR")}}async handleError(e,t){return this.state.clearActiveExtraction(t),this.state.recordFailure(e.payload.error),await this.showErrorNotification(e.payload.error),console.error(`‚ùå Content script error in tab ${t}:`,e.payload),{success:!0}}async handleKeyboardShortcut(){try{const e=await w.getActive();await this.handleExtractRequest({type:"EXTRACT_CONTEXT",timestamp:Date.now(),source:"background"},e.id)}catch(e){console.error("‚ùå Keyboard shortcut extraction failed:",e),await this.showErrorNotification(e instanceof Error?e.message:"Keyboard shortcut failed")}}async updateBadgeWithScore(e){try{await g.updateBadge(e)}catch(t){console.error("‚ùå Badge update failed:",t)}}async showSuccessNotification(e,t){try{const r=e;await A.create("FAF - Context Extracted! ‚ö°Ô∏è",`Score: ${r}% | Time: ${Math.round(t)}ms | Copied to clipboard`,"icons/social-logo-128.png")}catch(r){console.error("‚ùå Success notification failed:",r)}}async showErrorNotification(e){try{await A.create("FAF - Extraction Failed ‚ùå",`Error: ${e.substring(0,100)}${e.length>100?"...":""}`,"icons/social-logo-128.png")}catch(t){console.error("‚ùå Error notification failed:",t)}}isValidMessage(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.type=="string"&&typeof t.timestamp=="number"&&typeof t.source=="string"&&["popup","content","background","service-worker"].includes(t.source)}getHealthStatus(){const e=this.state.getStats(),t=this.state.getActiveExtractionCount(),r=this.state.getMemoryStats();return{isHealthy:(e.lastError===null||e.successfulExtractions>0&&e.successfulExtractions>e.failedExtractions)&&r.memoryPressure!=="high",stats:e,activeExtractions:t,memoryStats:r}}getTelemetryHealthReport(){const e=this.getHealthStatus();let t="healthy";const r=[];e.isHealthy||(t="critical",r.push("Service worker experiencing issues - check error logs")),e.memoryStats.memoryPressure==="high"&&(t==="healthy"&&(t="warning"),r.push("High memory pressure - consider restart"));const s=e.stats;if(s.totalExtractions>5){const n=s.successfulExtractions/s.totalExtractions;n<.8&&(t==="healthy"&&(t="warning"),r.push(`Low success rate: ${Math.round(n*100)}%`))}return r.length===0&&r.push("All systems operating normally"),{serviceWorker:e,combined:{overall:t,recommendations:r}}}cleanup(){this.state.destroy(),console.log("üßπ Service Worker Manager cleaned up successfully")}forceCleanup(){this.state.performCleanup(),console.log("üö® Service Worker forced cleanup completed")}}let h;try{h=new k,console.log("üèéÔ∏è FAF Service Worker Manager started successfully")}catch(o){throw console.error("üí• CRITICAL: Service Worker Manager failed to start:",o),o}chrome.runtime.onSuspend?.addListener(()=>{console.log("üõå Service Worker suspending - cleaning up resources");try{h.cleanup()}catch(o){console.error("‚ùå Error during service worker cleanup:",o)}}),chrome.runtime.onSuspendCanceled?.addListener(()=>{console.log("üîÑ Service Worker suspend canceled - reinitializing");try{const o=h.getHealthStatus();console.log("Health status after suspend cancel:",o)}catch(o){console.error("‚ùå Error checking health after suspend cancel:",o)}}),"memory"in performance&&typeof performance.memory.usedJSHeapSize=="number"&&setInterval(()=>{const o=performance.memory,e=o.usedJSHeapSize/1048576,t=o.totalJSHeapSize/1048576;e>50&&(console.warn(`‚ö†Ô∏è High memory usage: ${e.toFixed(1)}MB / ${t.toFixed(1)}MB`),h.getHealthStatus().memoryStats.memoryPressure==="high"&&(console.log("üö® Forcing cleanup due to memory pressure"),h.forceCleanup()))},3e4),setInterval(()=>{try{const o=h.getHealthStatus();o.isHealthy||(console.warn("‚ö†Ô∏è Service Worker health check failed:",o),o.memoryStats.memoryPressure==="high"&&h.forceCleanup())}catch(o){console.error("‚ùå Health check failed:",o)}},6e4),typeof globalThis<"u"&&(globalThis.__FAF_SERVICE_WORKER_MANAGER__=h,globalThis.__FAF_MEMORY_DEBUG__={getHealth:()=>h.getHealthStatus(),forceCleanup:()=>h.forceCleanup(),getMemoryUsage:()=>{if("memory"in performance){const o=performance.memory;return{used:o.usedJSHeapSize/1048576,total:o.totalJSHeapSize/1048576,limit:o.jsHeapSizeLimit/1048576}}return null}})})();
