(function(){"use strict";function F(s){return Math.min(100,Math.max(0,Math.round(s)))}var u=(s=>(s.PLATFORM_DETECTION_TIMEOUT="FAF_1001",s.PLATFORM_DETECTION_FAILED="FAF_1002",s.PLATFORM_NOT_SUPPORTED="FAF_1003",s.PLATFORM_DOM_ACCESS_DENIED="FAF_1004",s.EXTRACTION_TIMEOUT="FAF_1101",s.EXTRACTION_FAILED="FAF_1102",s.EXTRACTION_INVALID_DATA="FAF_1103",s.EXTRACTION_PERMISSION_DENIED="FAF_1104",s.EXTRACTION_RATE_LIMITED="FAF_1105",s.CHROME_TAB_ACCESS_DENIED="FAF_1201",s.CHROME_STORAGE_QUOTA_EXCEEDED="FAF_1202",s.CHROME_MESSAGING_FAILED="FAF_1203",s.CHROME_PERMISSIONS_MISSING="FAF_1204",s.CHROME_RUNTIME_ERROR="FAF_1205",s.CHROME_TAB_NOT_FOUND="FAF_1206",s.CHROME_API_UNAVAILABLE="FAF_1207",s.CHROME_MESSAGE_FAILED="FAF_1208",s.CHROME_SCRIPTING_FAILED="FAF_1209",s.CHROME_STORAGE_ERROR="FAF_1210",s.SERVICE_WORKER_INIT_FAILED="FAF_1301",s.SERVICE_WORKER_MESSAGE_FAILED="FAF_1302",s.SERVICE_WORKER_MEMORY_PRESSURE="FAF_1303",s.SERVICE_WORKER_TIMEOUT="FAF_1304",s.POPUP_LOAD_FAILED="FAF_1401",s.POPUP_ACTION_FAILED="FAF_1402",s.POPUP_DATA_CORRUPT="FAF_1403",s.CLIPBOARD_PERMISSION_DENIED="FAF_1501",s.CLIPBOARD_WRITE_FAILED="FAF_1502",s.CLIPBOARD_DATA_TOO_LARGE="FAF_1503",s.NETWORK_REQUEST_FAILED="FAF_1601",s.NETWORK_TIMEOUT="FAF_1602",s.NETWORK_RATE_LIMITED="FAF_1603",s.CONTENT_SCRIPT_INJECTION_FAILED="FAF_1701",s.CONTENT_SCRIPT_DOM_BLOCKED="FAF_1702",s.CONTENT_SCRIPT_CSP_VIOLATION="FAF_1703",s.UNKNOWN_ERROR="FAF_1901",s.SYSTEM_OVERLOAD="FAF_1902",s.CONFIGURATION_ERROR="FAF_1903",s.DEPENDENCY_ERROR="FAF_1904",s))(u||{}),p=(s=>(s.LOW="low",s.MEDIUM="medium",s.HIGH="high",s.CRITICAL="critical",s))(p||{}),f=(s=>(s.RETRY="retry",s.FALLBACK="fallback",s.GRACEFUL_DEGRADATION="degrade",s.USER_ACTION_REQUIRED="user",s.RESTART_REQUIRED="restart",s.NO_RECOVERY="none",s))(f||{});class c extends Error{code;severity;userMessage;technicalDetails;recoveryStrategy;recoveryActions;context;timestamp;constructor(e,t,r={}){super(t,{cause:r.cause}),this.name="FAFError",this.code=e,this.timestamp=Date.now();const n=T.getErrorInfo(e);this.severity=n.severity,this.recoveryStrategy=n.recoveryStrategy,this.recoveryActions=n.recoveryActions,this.userMessage=r.userMessage||n.userMessage,this.technicalDetails=r.technicalDetails,this.context={timestamp:this.timestamp,platform:r.context?.platform,url:r.context?.url||(typeof window<"u"?window.location.href:void 0),userAgent:r.context?.userAgent||(typeof navigator<"u"?navigator.userAgent:void 0),sessionId:r.context?.sessionId},this.trackError()}static fromUnknown(e,t){if(e instanceof c)return e;if(e instanceof Error){let n="FAF_1901";return e.message.includes("timeout")?n="FAF_1101":e.message.includes("permission")?n="FAF_1204":e.message.includes("DOM")||e.message.includes("document")?n="FAF_1004":e.message.includes("quota")&&(n="FAF_1202"),new c(n,e.message,{cause:e,technicalDetails:e.stack,context:t})}const r=typeof e=="string"?e:String(e);return new c("FAF_1901",r,{context:t})}isRecoverable(){return this.recoveryStrategy!=="none"}requiresUserAction(){return this.recoveryStrategy==="user"}getDisplayInfo(){return{title:this.getErrorTitle(),message:this.userMessage,actions:this.recoveryActions,severity:this.severity,canRetry:this.recoveryStrategy==="retry"}}toJSON(){return{code:this.code,severity:this.severity,message:this.message,userMessage:this.userMessage,technicalDetails:this.technicalDetails,recoveryStrategy:this.recoveryStrategy,recoveryActions:this.recoveryActions,context:this.context,timestamp:this.timestamp,stack:this.stack}}getErrorTitle(){return{low:"Minor Issue",medium:"Issue Detected",high:"Extraction Problem",critical:"Critical Error"}[this.severity]}trackError(){try{console.warn(`[FAF Error ${this.code}] ${this.severity}: ${this.message}`)}catch{}}}class T{static errorDefinitions=new Map([["FAF_1001",{code:"FAF_1001",severity:"medium",message:"Platform detection timed out",userMessage:"Unable to detect the current platform quickly enough. The page may be loading slowly.",recoveryStrategy:"retry",recoveryActions:["Wait for page to load completely","Refresh the page","Try extraction again"]}],["FAF_1003",{code:"FAF_1003",severity:"medium",message:"Platform is not supported",userMessage:"This website is not currently supported by FAF. We support GitHub, Monaco Editor, CodeMirror, and other development platforms.",recoveryStrategy:"degrade",recoveryActions:["Try on a supported platform","Copy code manually","Request platform support"]}],["FAF_1004",{code:"FAF_1004",severity:"high",message:"DOM access denied",userMessage:"Cannot access page content due to security restrictions. This may be due to strict Content Security Policy.",recoveryStrategy:"user",recoveryActions:["Refresh the page","Check browser security settings","Try on a different page"]}],["FAF_1101",{code:"FAF_1101",severity:"medium",message:"Context extraction timed out",userMessage:"Extraction took longer than expected. The page may have complex content or be loading slowly.",recoveryStrategy:"retry",recoveryActions:["Wait a moment and try again","Refresh the page","Check internet connection"]}],["FAF_1104",{code:"FAF_1104",severity:"high",message:"Permission denied for extraction",userMessage:"FAF does not have permission to access this page. Please check extension permissions.",recoveryStrategy:"user",recoveryActions:["Check extension permissions in browser settings","Reload the extension","Refresh the page"]}],["FAF_1201",{code:"FAF_1201",severity:"high",message:"Chrome tab access denied",userMessage:"Cannot access the current tab. Please ensure FAF has the necessary permissions.",recoveryStrategy:"user",recoveryActions:["Grant tab permissions to FAF","Reload the extension","Check browser security settings"]}],["FAF_1202",{code:"FAF_1202",severity:"medium",message:"Chrome storage quota exceeded",userMessage:"Extension storage is full. Some data may not be saved.",recoveryStrategy:"fallback",recoveryActions:["Clear extension data","Restart browser","Continue without saving preferences"]}],["FAF_1204",{code:"FAF_1204",severity:"critical",message:"Required Chrome permissions missing",userMessage:"FAF is missing required permissions to function properly.",recoveryStrategy:"user",recoveryActions:["Go to chrome://extensions/","Find FAF extension","Grant required permissions"]}],["FAF_1206",{code:"FAF_1206",severity:"medium",message:"No active tab found",userMessage:"No active tab detected. Please open a supported page.",recoveryStrategy:"user",recoveryActions:["Open a supported website","Refresh the current page","Try a different tab"]}],["FAF_1207",{code:"FAF_1207",severity:"high",message:"Chrome API unavailable",userMessage:"Chrome extension APIs are not available.",recoveryStrategy:"restart",recoveryActions:["Restart browser","Check Chrome version","Reinstall extension"]}],["FAF_1208",{code:"FAF_1208",severity:"medium",message:"Chrome message failed",userMessage:"Failed to communicate with the page. Please try again.",recoveryStrategy:"retry",recoveryActions:["Try again","Refresh the page","Check page permissions"]}],["FAF_1209",{code:"FAF_1209",severity:"high",message:"Script injection failed",userMessage:"Unable to inject required scripts into the page.",recoveryStrategy:"fallback",recoveryActions:["Refresh the page","Try a different page","Check site permissions"]}],["FAF_1210",{code:"FAF_1210",severity:"medium",message:"Chrome storage error",userMessage:"Unable to save data. Some features may not persist.",recoveryStrategy:"degrade",recoveryActions:["Continue without saving","Clear extension data","Restart browser"]}],["FAF_1301",{code:"FAF_1301",severity:"critical",message:"Service worker initialization failed",userMessage:"Extension background service failed to start. Please restart the browser.",recoveryStrategy:"restart",recoveryActions:["Restart browser","Reload extension","Check for browser updates"]}],["FAF_1303",{code:"FAF_1303",severity:"medium",message:"Service worker under memory pressure",userMessage:"Extension is using high memory. Performance may be affected.",recoveryStrategy:"degrade",recoveryActions:["Close unused tabs","Restart browser","Limit concurrent extractions"]}],["FAF_1501",{code:"FAF_1501",severity:"medium",message:"Clipboard permission denied",userMessage:"Cannot copy to clipboard automatically. You can copy the content manually.",recoveryStrategy:"fallback",recoveryActions:["Grant clipboard permission","Copy content manually","Use Ctrl+C to copy"]}],["FAF_1503",{code:"FAF_1503",severity:"low",message:"Clipboard data too large",userMessage:"The extracted content is too large for clipboard. Consider extracting smaller sections.",recoveryStrategy:"degrade",recoveryActions:["Extract smaller code sections","Copy parts manually","Save to file instead"]}],["FAF_1703",{code:"FAF_1703",severity:"high",message:"Content Security Policy violation",userMessage:"Page security settings prevent FAF from working. This is common on some secure sites.",recoveryStrategy:"degrade",recoveryActions:["Try on a different page","Use manual copy instead","Contact site administrator"]}],["FAF_1901",{code:"FAF_1901",severity:"medium",message:"An unexpected error occurred",userMessage:"Something unexpected happened. Please try again or restart the browser.",recoveryStrategy:"retry",recoveryActions:["Try the action again","Refresh the page","Restart browser if issues persist"]}]]);static getErrorInfo(e){const t=this.errorDefinitions.get(e);return t||{code:e,severity:"medium",message:"Unknown error",userMessage:"An unknown error occurred. Please try again.",recoveryStrategy:"retry",recoveryActions:["Try again","Restart extension"]}}static getAllErrorCodes(){return Array.from(this.errorDefinitions.keys())}}class E{hostname;pathname;maxTimeout=100;cachedResult=void 0;activeDetection=void 0;CACHE_TTL=5e3;constructor(){this.hostname=window.location.hostname,this.pathname=window.location.pathname,this.setupNavigationListeners()}async detect(){return this.activeDetection?this.activeDetection:this.isCacheFresh()?Promise.resolve(this.cachedResult.platform):(this.activeDetection=this.performDetection().then(e=>(this.cacheResult(e),e)).finally(()=>{this.activeDetection=void 0}),this.activeDetection)}invalidateCache(){this.cachedResult=void 0}getCached(){return this.isCacheFresh()?this.cachedResult.platform:null}isCacheFresh(){return this.cachedResult?Date.now()-this.cachedResult.timestamp<this.CACHE_TTL:!1}cacheResult(e){this.cachedResult={platform:e,timestamp:Date.now(),confidence:this.calculateConfidence(e)}}calculateConfidence(e){return e==="github"&&this.hostname.includes("github.com")||e==="gitlab"&&this.hostname.includes("gitlab")?95:e==="monaco"&&window.monaco||e==="stackblitz"&&this.hostname.includes("stackblitz")?90:e!=="unknown"&&e!=="has-code"?75:50}setupNavigationListeners(){typeof window<"u"&&(window.addEventListener("popstate",()=>this.invalidateCache()),window.addEventListener("pushstate",()=>this.invalidateCache()),window.addEventListener("replacestate",()=>this.invalidateCache()))}async performDetection(){performance.mark("platform-detection-start");try{const e=this.detectFastPath();if(e!=="unknown")return e;const t=await this.detectWithTimeout(this.maxTimeout);return t!=="unknown"?t:this.detectFromUserAgent()}catch(e){throw e instanceof Error&&e.message.includes("timeout")?new c(u.PLATFORM_DETECTION_TIMEOUT,"Platform detection timed out",{cause:e,context:{platform:"unknown",url:window.location.href,timestamp:Date.now()}}):e instanceof Error&&e.message.includes("DOM")?new c(u.PLATFORM_DOM_ACCESS_DENIED,"Cannot access page DOM",{cause:e,context:{platform:"unknown",url:window.location.href,timestamp:Date.now()}}):e instanceof c?e:new c(u.PLATFORM_DETECTION_FAILED,"Platform detection failed",{cause:e instanceof Error?e:new Error(String(e)),context:{platform:"unknown",url:window.location.href,timestamp:Date.now()}})}finally{performance.mark("platform-detection-end"),performance.measure("platform-detection","platform-detection-start","platform-detection-end")}}async detectPlatformAsync(){return this.detect()}async extractContextAsync(){performance.mark("context-extraction-start");try{const e=await this.detect();let t;switch(e){case"monaco":t=await this.extractMonacoContext();break;case"github":t=await this.extractGitHubContext();break;case"codemirror":t=await this.extractCodeMirrorContext();break;case"stackblitz":t=await this.extractStackBlitzContext();break;case"codesandbox":t=await this.extractCodeSandboxContext();break;case"localhost":t=await this.extractLocalhostContext();break;default:t=await this.extractGenericContext()}return performance.mark("context-extraction-end"),performance.measure("context-extraction","context-extraction-start","context-extraction-end"),this.buildCodeContext(e,t)}catch(e){return console.warn("Context extraction failed:",e),performance.mark("context-extraction-end"),performance.measure("context-extraction","context-extraction-start","context-extraction-end"),this.buildFallbackContext()}}detectFastPath(){return this.isMonacoAvailable()?"monaco":this.hostname.includes("github.com")?"github":this.hostname.includes("gitlab.com")?"gitlab":this.hostname.includes("stackblitz.com")?"stackblitz":this.hostname.includes("codesandbox.io")?"codesandbox":this.hostname.includes("codepen.io")?"codepen":this.hostname.includes("vscode.dev")||this.hostname.includes("github.dev")?"vscode-web":this.isLocalhost()?"localhost":this.isCodeMirrorAvailable()?"codemirror":"unknown"}async detectWithTimeout(e=this.maxTimeout){return new Promise(t=>{const r=setTimeout(()=>{t("unknown")},e);this.performAsyncDetection().then(n=>{clearTimeout(r),t(n)}).catch(()=>{clearTimeout(r),t("unknown")})})}async performAsyncDetection(){return await this.waitForDOM(),this.hasSignificantCodeElements()?"has-code":"unknown"}isMonacoAvailable(){try{return"monaco"in window&&window.monaco!=null&&typeof window.monaco.editor<"u"}catch{return!1}}isCodeMirrorAvailable(){try{return"CodeMirror"in window&&window.CodeMirror!=null}catch{return!1}}isLocalhost(){return this.hostname==="localhost"||this.hostname==="127.0.0.1"||this.hostname.includes("localhost")}hasSignificantCodeElements(){try{const e=["pre code",".highlight",".hljs",'[class*="language-"]','[class*="lang-"]',".code-block"];let t=0;for(const r of e)if(t+=document.querySelectorAll(r).length,t>=3)return!0;return!1}catch{return!1}}async waitForDOM(){return new Promise(e=>{document.readyState==="complete"||document.readyState==="interactive"?e():document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})})}detectFromURL(){try{const e=window.location.hostname.toLowerCase(),t=window.location.pathname.toLowerCase();if(e.includes("github.com")||e.includes("github.io"))return"github";if(e.includes("gitlab.com")||e.includes("gitlab.io"))return"gitlab";if(e.includes("stackblitz.com")||e.includes("stackblitz.io"))return"stackblitz";if(e.includes("codesandbox.io")||e.includes("csb.app"))return"codesandbox";if(e.includes("codepen.io")||e.includes("codepen.com"))return"codepen";if(e.includes("vscode.dev")||t.includes("vscode"))return"vscode-web";if(e==="localhost"||e==="127.0.0.1"||e.startsWith("192.168."))return"localhost";const r=window.location.port;if(r&&["3000","3001","4200","5173","8000","8080","9000"].includes(r))return"localhost"}catch(e){console.warn("URL-based detection failed:",e)}return"unknown"}detectFromUserAgent(){try{const e=navigator.userAgent.toLowerCase();if(e.includes("vscode")||e.includes("electron")||typeof window.acquireVsCodeApi=="function")return"vscode-web"}catch(e){console.warn("User agent detection failed:",e)}return"unknown"}circuitBreaker={failures:0,maxFailures:5,resetTimeout:6e4,lastFailureTime:0,isOpen(){const e=Date.now();return this.failures>=this.maxFailures?e-this.lastFailureTime>this.resetTimeout?(this.failures=0,!1):!0:!1},recordFailure(){this.failures++,this.lastFailureTime=Date.now()},recordSuccess(){this.failures=0}};async __detectWithCircuitBreaker(){if(this.circuitBreaker.isOpen())return console.warn("🚫 Platform detection circuit breaker is open - using fallback"),this.detectFromURL()||"unknown";try{const e=await this.detect();return this.circuitBreaker.recordSuccess(),e}catch(e){return this.circuitBreaker.recordFailure(),console.error("Platform detection failed, circuit breaker triggered:",e),"unknown"}}async extractMonacoContext(){try{if(!window.monaco?.editor)throw new Error("Monaco editor not available");const e=window.monaco.editor.getModels(),t=e.map(r=>{const n=r.uri.toString(),o=r.getValue();return{path:n.replace(/^file:\/\/\//,""),language:r.getLanguageId(),content:o,lines:o.split(`
`).length,size:o.length}});return{files:t,confidence:100,metadata:{editorType:"monaco",modelCount:e.length,totalSize:t.reduce((r,n)=>r+n.size,0)}}}catch(e){return console.warn("Monaco context extraction failed:",e),this.getFallbackExtractedData()}}async extractGitHubContext(){try{const e=[];let t=75;const r=await this.extractGitHubFiles();e.push(...r.files),t+=r.confidenceBonus;const n=document.querySelector(".blob-wrapper .blob-code-content, .markdown-body");if(n){const o=n.textContent||"",a=window.location.pathname.split("/").pop()||"unknown";e.push({path:a,language:this.detectLanguageFromPath(a),content:o,lines:o.split(`
`).length,size:new TextEncoder().encode(o).length}),t+=5}return{files:e,confidence:Math.min(100,t),metadata:{fileCount:e.length,hasPackageJson:d.hasPackageJson(),hasReadme:d.hasReadme(),hasTsConfig:d.hasTsConfig(),repository:this.extractGitHubRepo()}}}catch(e){return console.warn("GitHub context extraction failed:",e),this.getFallbackExtractedData()}}async extractGitHubFiles(){const e=[];let t=0;const r=this.extractFileTreeStrategy1();if(r.length>0)return e.push(...r),t+=15,console.log(`GitHub Strategy 1: Found ${r.length} files`),{files:e,confidenceBonus:t};const n=this.extractFileTreeStrategy2();if(n.length>0)return e.push(...n),t+=10,console.log(`GitHub Strategy 2: Found ${n.length} files`),{files:e,confidenceBonus:t};const o=await this.extractFileTreeStrategy3();if(o.length>0)return e.push(...o),t+=12,console.log(`GitHub Strategy 3: Found ${o.length} files`),{files:e,confidenceBonus:t};const a=this.extractFileTreeStrategy4();return a.length>0&&(e.push(...a),t+=5,console.log(`GitHub Strategy 4: Found ${a.length} files`)),{files:e,confidenceBonus:t}}extractFileTreeStrategy1(){const e=[],t=['[role="rowheader"] .Link--primary','[role="gridcell"] a[href*="/blob/"]','[data-testid="file-tree"] a',".react-directory-filename-column a",'[role="row"] [role="gridcell"]:first-child a'];for(const r of t)try{const n=document.querySelectorAll(r);if(n.length>0){n.forEach(o=>{const a=o.textContent?.trim(),i=o.getAttribute("href");a&&i&&e.push({path:a,language:this.detectLanguageFromPath(a),content:"",lines:0,size:0})});break}}catch(n){console.warn(`GitHub Strategy 1 selector failed: ${r}`,n)}return e}extractFileTreeStrategy2(){const e=[],t=[".js-navigation-open",'.content a[href*="/blob/"]',".file-wrap .content a",".repository-content a[title]","[data-pjax] .content a"];for(const r of t)try{const n=document.querySelectorAll(r);if(n.length>0){n.forEach(o=>{const a=o.textContent?.trim()||o.getAttribute("title"),i=o.getAttribute("href");a&&i&&i.includes("/blob/")&&e.push({path:a,language:this.detectLanguageFromPath(a),content:"",lines:0,size:0})});break}}catch(n){console.warn(`GitHub Strategy 2 selector failed: ${r}`,n)}return e}async extractFileTreeStrategy3(){try{if(window.location.pathname.split("/").length<3)return[];const t=document.querySelector("[data-repository]");if(t&&t.getAttribute("data-repository")){const a=document.querySelector(".BorderGrid-cell .color-fg-default");if(a){const i=a.textContent?.toLowerCase()||"";return this.generateTypicalFilesForLanguage(i)}}const r=document.querySelectorAll('[data-octo-click="topic_click"] .topic-tag'),n=Array.from(r).map(o=>o.textContent?.toLowerCase()||"");if(n.length>0)return this.generateTypicalFilesForTopics(n)}catch(e){console.warn("GitHub Strategy 3 failed:",e)}return[]}extractFileTreeStrategy4(){const e=[];try{const t=window.location.pathname.split("/"),r=t.findIndex(o=>o==="blob");if(r!==-1&&t.length>r+2){const o=t.slice(r+2).join("/"),a=t[t.length-1]||"unknown";e.push({path:o,language:this.detectLanguageFromPath(a),content:this.extractCurrentFileContent(),lines:this.countLinesInCurrentFile(),size:this.estimateCurrentFileSize()})}document.querySelectorAll('nav[aria-label="Breadcrumb"] a, .breadcrumb a').forEach(o=>{const a=o.textContent?.trim();a&&a.includes(".")&&e.push({path:a,language:this.detectLanguageFromPath(a),content:"",lines:0,size:0})})}catch(t){console.warn("GitHub Strategy 4 failed:",t)}return e}generateTypicalFilesForLanguage(e){const t=[],n={javascript:["package.json","index.js","README.md",".gitignore"],typescript:["package.json","tsconfig.json","index.ts","README.md"],python:["requirements.txt","main.py","setup.py","README.md"],java:["pom.xml","Main.java","README.md","gradle.properties"],go:["go.mod","main.go","README.md","Dockerfile"],rust:["Cargo.toml","main.rs","README.md","Cargo.lock"]}[e];return n&&n.forEach(o=>{t.push({path:o,language:this.detectLanguageFromPath(o),content:"",lines:0,size:0})}),t}generateTypicalFilesForTopics(e){const t=[];return e.some(r=>["react","vue","angular","frontend"].includes(r))&&t.push({path:"package.json",language:"JSON",content:"",lines:0,size:0},{path:"src/index.js",language:"JavaScript",content:"",lines:0,size:0}),e.some(r=>["docker","containerization"].includes(r))&&t.push({path:"Dockerfile",language:"Dockerfile",content:"",lines:0,size:0},{path:"docker-compose.yml",language:"YAML",content:"",lines:0,size:0}),e.some(r=>["kubernetes","k8s"].includes(r))&&t.push({path:"deployment.yaml",language:"YAML",content:"",lines:0,size:0}),t}extractCurrentFileContent(){const e=[".blob-wrapper .blob-code-content",".markdown-body",".file-editor-textarea","pre.highlight",".blob-code-inner"];for(const t of e){const r=document.querySelector(t);if(r)return r.textContent||""}return""}countLinesInCurrentFile(){const e=this.extractCurrentFileContent();return e?e.split(`
`).length:0}estimateCurrentFileSize(){const e=this.extractCurrentFileContent();return new TextEncoder().encode(e).length}async extractCodeMirrorContext(){try{const e=[];return window.CodeMirror?.instances&&window.CodeMirror.instances.forEach((t,r)=>{try{const n=t.getValue(),a=t.getMode()?.name||"text";e.push({path:`editor_${r+1}.${this.getExtensionFromLanguage(a)}`,language:a,content:n,lines:n.split(`
`).length,size:n.length})}catch(n){console.warn(`Failed to extract from CodeMirror instance ${r}:`,n)}}),e.length===0&&document.querySelectorAll(".CodeMirror").forEach((r,n)=>{try{const o=r.textContent||"";o.length>10&&e.push({path:`codemirror_${n+1}.txt`,language:"text",content:o,lines:o.split(`
`).length,size:o.length})}catch(o){console.warn(`Failed to extract from CodeMirror DOM ${n}:`,o)}}),{files:e,confidence:e.length>0?85:40,metadata:{editorType:"codemirror",instanceCount:e.length}}}catch(e){return console.warn("CodeMirror context extraction failed:",e),this.getFallbackExtractedData()}}async extractStackBlitzContext(){try{if(this.isMonacoAvailable()){const e=await this.extractMonacoContext();return{...e,confidence:Math.min(95,e.confidence),metadata:{...e.metadata,platform:"stackblitz"}}}return this.extractGenericContext()}catch(e){return console.warn("StackBlitz context extraction failed:",e),this.getFallbackExtractedData()}}async extractCodeSandboxContext(){try{if(this.isMonacoAvailable()){const e=await this.extractMonacoContext();return{...e,confidence:Math.min(95,e.confidence),metadata:{...e.metadata,platform:"codesandbox"}}}return this.extractGenericContext()}catch(e){return console.warn("CodeSandbox context extraction failed:",e),this.getFallbackExtractedData()}}async extractLocalhostContext(){try{const e=document.title.toLowerCase(),t=e.includes("webpack")||e.includes("vite")||e.includes("dev server");return this.extractGenericContext(t?60:40)}catch(e){return console.warn("Localhost context extraction failed:",e),this.getFallbackExtractedData()}}async extractGenericContext(e=30){try{const t=[];document.querySelectorAll("pre code, .highlight, .hljs").forEach((o,a)=>{const i=o.textContent||"";if(i.length>20){const l=this.detectLanguageFromElement(o);t.push({path:`code_block_${a+1}.${this.getExtensionFromLanguage(l)}`,language:l,content:i,lines:i.split(`
`).length,size:i.length})}});const n=Math.min(60,e+t.length*5);return{files:t,confidence:n,metadata:{codeBlockCount:t.length,extractionMethod:"generic-dom"}}}catch(t){return console.warn("Generic context extraction failed:",t),this.getFallbackExtractedData()}}buildCodeContext(e,t){return{platform:e,score:F(t.confidence),structure:{files:t.files,directories:this.extractDirectories(t.files),entryPoints:this.detectEntryPoints(t.files),totalFiles:t.files.length,totalLines:t.files.reduce((r,n)=>r+n.lines,0)},dependencies:{runtime:{language:this.detectPrimaryLanguage(t.files),version:"Unknown",packageManager:"npm"},packages:[],lockFile:null},environment:{variables:[],configFiles:[]},metadata:{extractionTime:performance.now(),version:"1.0.0",timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent}}}buildFallbackContext(){return{platform:"unknown",score:F(25),structure:{files:[],directories:[],entryPoints:[],totalFiles:0,totalLines:0},dependencies:{runtime:{language:"Unknown",version:"Unknown",packageManager:"unknown"},packages:[],lockFile:null},environment:{variables:[],configFiles:[]},metadata:{extractionTime:performance.now(),version:"1.0.0",timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent}}}getFallbackExtractedData(){return{files:[],confidence:25,metadata:{extractionMethod:"fallback"}}}extractGitHubRepo(){const e=this.pathname.split("/");return e.length>=3?`${e[1]}/${e[2]}`:"unknown"}detectLanguageFromPath(e){const t=e.split(".").pop()?.toLowerCase();return{ts:"typescript",js:"javascript",py:"python",java:"java",cpp:"cpp",c:"c",cs:"csharp",php:"php",rb:"ruby",go:"go",rs:"rust",html:"html",css:"css",scss:"scss",json:"json",xml:"xml",yml:"yaml",yaml:"yaml",md:"markdown"}[t||""]||"text"}detectLanguageFromElement(e){const t=Array.from(e.classList);for(const r of t){if(r.startsWith("language-"))return r.replace("language-","");if(r.startsWith("lang-"))return r.replace("lang-","")}return"text"}getExtensionFromLanguage(e){return{javascript:"js",typescript:"ts",python:"py",java:"java",cpp:"cpp",csharp:"cs",php:"php",ruby:"rb",go:"go",rust:"rs",html:"html",css:"css",json:"json",xml:"xml",yaml:"yml",markdown:"md"}[e.toLowerCase()]||"txt"}detectPlatform(){console.warn("⚠️ detectPlatform() is deprecated. Use await detect() instead to avoid race conditions.");const e=this.getCached();return e||this.detectFastPath()}extractContext(){const e=this.detectFastPath();return{platform:e,score:F(e==="unknown"?25:75),structure:{files:[],directories:[],entryPoints:[],totalFiles:0,totalLines:0},dependencies:{runtime:{language:"Unknown",version:"Unknown",packageManager:"npm"},packages:[],lockFile:null},environment:{variables:[],configFiles:[]},metadata:{extractionTime:performance.now(),version:"1.0.0",timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent}}}extractDirectories(e){const t=new Set;return e.forEach(r=>{const n=r.path.split("/");n.length>1&&n[0]&&t.add(n[0])}),Array.from(t)}detectEntryPoints(e){const t=[],r=["index.","main.","app.","server."];return e.forEach(n=>{const o=n.path.split("/").pop()??"";r.some(a=>o.startsWith(a))&&t.push(n.path)}),t}detectPrimaryLanguage(e){if(e.length===0)return"Unknown";const t=new Map;e.forEach(o=>{const a=t.get(o.language)??0;t.set(o.language,a+1)});let r=0,n="Unknown";for(const[o,a]of t)a>r&&(r=a,n=o);return n}}class b{static extractMonacoFiles(){if(!window.monaco?.editor)return[];try{return window.monaco.editor.getModels().map(t=>{const r=t.uri.toString(),n=t.getLanguageId(),o=t.getValue();return{path:r.replace(/^file:\/\/\//,""),language:n,content:o,lines:o.split(`
`).length,size:o.length}})}catch{return[]}}static extractCodeMirrorFiles(){const e=window.CodeMirror;if(!e?.instances)return[];try{return e.instances.map((t,r)=>{const n=t.getValue(),a=t.getMode().name??"text";return{path:`file_${r+1}.${this.getExtensionFromLanguage(a)}`,language:a,content:n,lines:n.split(`
`).length,size:n.length}})}catch{return[]}}static extractVSCodeWebFiles(){try{const e=document.querySelectorAll(".monaco-editor .view-lines"),t=[];return e.forEach((r,n)=>{const o=r.textContent??"";t.push({path:`file_${n+1}.txt`,language:"text",content:o,lines:o.split(`
`).length,size:o.length})}),t}catch{return[]}}static getExtensionFromLanguage(e){return{javascript:"js",typescript:"ts",python:"py",java:"java",cpp:"cpp",csharp:"cs",php:"php",ruby:"rb",go:"go",rust:"rs",html:"html",css:"css",json:"json",xml:"xml",yaml:"yml",markdown:"md"}[e.toLowerCase()]??"txt"}}class d{static hasPackageJson(){return['a[href*="package.json"]','[role="rowheader"]:has-text("package.json")','.js-navigation-open[title*="package.json"]','[data-testid="file-tree"] a[title*="package.json"]','a[href$="/package.json"]'].some(t=>{try{return document.querySelector(t)!==null}catch{return!1}})}static hasEnvironmentFile(){return['a[href*=".env"]','a[href*=".env.local"]','a[href*=".env.example"]','a[href*=".env.production"]','a[href*=".env.development"]','[role="rowheader"]:has-text(".env")','.js-navigation-open[title*=".env"]','[data-testid="file-tree"] a[title*=".env"]'].some(t=>{try{return document.querySelector(t)!==null}catch{return!1}})}static hasReadme(){return['a[href*="README.md"]','a[href*="README.rst"]','a[href*="README.txt"]','a[href*="readme.md"]','a[href*="Readme.md"]','[role="rowheader"]:has-text("README")','.js-navigation-open[title*="README"]','[data-testid="file-tree"] a[title*="README"]','a[href$="/README.md"]','a[href$="/readme.md"]'].some(t=>{try{return document.querySelector(t)!==null}catch{return!1}})}static hasDockerfile(){return['a[href*="Dockerfile"]','a[href*="dockerfile"]','[role="rowheader"]:has-text("Dockerfile")','.js-navigation-open[title*="Dockerfile"]','[data-testid="file-tree"] a[title*="Dockerfile"]','a[href$="/Dockerfile"]'].some(t=>{try{return document.querySelector(t)!==null}catch{return!1}})}static hasTsConfig(){return['a[href*="tsconfig.json"]','[role="rowheader"]:has-text("tsconfig.json")','.js-navigation-open[title*="tsconfig.json"]','[data-testid="file-tree"] a[title*="tsconfig.json"]','a[href$="/tsconfig.json"]'].some(t=>{try{return document.querySelector(t)!==null}catch{return!1}})}static hasConfigFiles(){return['a[href*="webpack.config"]','a[href*="vite.config"]','a[href*="rollup.config"]','a[href*="babel.config"]','a[href*="eslint.config"]','a[href*="next.config"]','a[href*="nuxt.config"]','a[href*="tailwind.config"]','[role="rowheader"]:has-text("config")','.js-navigation-open[title*="config"]','[data-testid="file-tree"] a[title*="config"]','a[href$=".config.js"]','a[href$=".config.ts"]','a[href$=".config.json"]'].some(t=>{try{return document.querySelector(t)!==null}catch{return!1}})}static async detectFilesWithRetry(){let e=[],t=0,r=0;const n=3;for(;r<n&&e.length===0;)try{const o=d.extractModernGitHubFiles();if(o.length>0){e=o,t=90;break}const a=d.extractLegacyGitHubFiles();if(a.length>0){e=a,t=75;break}const i=d.extractFilesFromText();i.length>0&&(e=i,t=60),r++,r<n&&await new Promise(l=>setTimeout(l,100))}catch(o){console.warn(`GitHub file detection attempt ${r+1} failed:`,o),r++}return{files:e,confidence:t}}static extractModernGitHubFiles(){const e=['[role="rowheader"] .Link--primary','[role="gridcell"] a[href*="/blob/"]','[data-testid="file-tree"] a',".react-directory-filename-column a"];for(const t of e)try{const r=document.querySelectorAll(t);if(r.length>0)return Array.from(r).map(n=>n.textContent?.trim()).filter(Boolean)}catch(r){console.warn(`Modern GitHub selector failed: ${t}`,r)}return[]}static extractLegacyGitHubFiles(){const e=[".js-navigation-open",'.content a[href*="/blob/"]',".file-wrap .content a",".repository-content a[title]"];for(const t of e)try{const r=document.querySelectorAll(t);if(r.length>0)return Array.from(r).map(n=>n.textContent?.trim()||n.getAttribute("title")).filter(Boolean)}catch(r){console.warn(`Legacy GitHub selector failed: ${t}`,r)}return[]}static extractFilesFromText(){try{const e=document.body.textContent||"",t=[/\b[\w-]+\.(js|ts|jsx|tsx|py|java|go|rs|cpp|c|h|php|rb)\b/g,/\b(package\.json|tsconfig\.json|Dockerfile|README\.md|\.gitignore)\b/g],r=new Set;return t.forEach(n=>{const o=e.match(n);o&&o.forEach(a=>r.add(a))}),Array.from(r).slice(0,20)}catch(e){return console.warn("Text-based file extraction failed:",e),[]}}static getBonusFeatures(){const e=[];return this.hasPackageJson()&&e.push("package-json"),this.hasEnvironmentFile()&&e.push("env-file"),this.hasReadme()&&e.push("readme"),this.hasDockerfile()&&e.push("dockerfile"),this.hasTsConfig()&&e.push("typescript"),this.hasConfigFiles()&&e.push("config-files"),e}}class v{static countCodeBlocks(){const e=["pre","code",".highlight",".code",".hljs",'[class*="language-"]','[class*="lang-"]'];let t=0;return e.forEach(r=>{t+=document.querySelectorAll(r).length}),t}static getCodeLanguages(){const e=document.querySelectorAll('[class*="language-"], [class*="lang-"]'),t=new Set;return e.forEach(r=>{Array.from(r.classList).forEach(o=>{o.startsWith("language-")?t.add(o.replace("language-","")):o.startsWith("lang-")&&t.add(o.replace("lang-",""))})}),Array.from(t)}}const S=Object.freeze(Object.defineProperty({__proto__:null,CodeBlockDetector:v,GitHubDetector:d,PlatformDetector:E,PlatformExtractors:b},Symbol.toStringTag,{value:"Module"})),R={platform:.6,files:.15,dependencies:.1,environment:.05,codeBlocks:.05,githubFeatures:.05};class M{weights;constructor(e=R){this.weights=this.validateWeights(e)}calculateScore(e){const t=this.calculatePlatformScore(e.platform),r=this.calculateFilesScore(e),n=this.calculateDependenciesScore(e),o=this.calculateEnvironmentScore(e),a=this.calculateCodeBlocksScore(),i=this.calculateGitHubScore(e.platform),l=t*this.weights.platform+r*this.weights.files+n*this.weights.dependencies+o*this.weights.environment+a*this.weights.codeBlocks+i*this.weights.githubFeatures;return this.createScore(Math.round(l))}calculatePlatformScore(e){return{monaco:100,stackblitz:95,codesandbox:95,"vscode-web":90,codemirror:85,github:75,gitlab:70,codepen:60,localhost:50,"has-code":40,unknown:25}[e]}calculateFilesScore(e){const t=e.structure.totalFiles,r=e.structure.totalLines,n=e.structure.entryPoints.length;let o=0;t>0&&(o+=Math.min(30,t*3)),r>0&&(o+=Math.min(20,Math.floor(r/100))),n>0&&(o+=Math.min(15,n*5));const a=new Set(e.structure.files.map(i=>i.language));return a.size>1&&(o+=Math.min(10,a.size*2)),Math.min(100,o)}calculateDependenciesScore(e){let t=0;const r=e.dependencies;return r.runtime.language&&r.runtime.language!=="unknown"&&(t+=30),r.packages.length>0&&(t+=Math.min(40,r.packages.length*2)),r.lockFile&&(t+=20),r.runtime.packageManager!=="unknown"&&(t+=10),Math.min(100,t)}calculateEnvironmentScore(e){let t=0;const r=e.environment;r.variables.length>0&&(t+=Math.min(50,r.variables.length*10)),r.configFiles.length>0&&(t+=Math.min(30,r.configFiles.length*5));const n=r.variables.filter(o=>o.isRequired).length;return n>0&&(t+=Math.min(20,n*5)),Math.min(100,t)}calculateCodeBlocksScore(){const e=v.countCodeBlocks(),t=v.getCodeLanguages();let r=0;e>0&&(r+=Math.min(40,e*5)),t.length>0&&(r+=Math.min(30,t.length*10));const n=document.querySelectorAll('.hljs, [class*="highlight"]').length;return n>0&&(r+=Math.min(30,n*3)),Math.min(100,r)}calculateGitHubScore(e){if(e!=="github")return 0;const t=d.getBonusFeatures();let r=0;return t.forEach(n=>{switch(n){case"package-json":r+=25;break;case"env-file":r+=15;break;case"readme":r+=10;break;case"dockerfile":r+=15;break;case"typescript":r+=10;break;case"config-files":r+=10;break;default:r+=5}}),Math.min(100,r)}createScore(e){return Math.min(100,Math.max(0,Math.round(e)))}validateWeights(e){const t=Object.values(e).reduce((n,o)=>n+o,0);if(Math.abs(t-1)>.001)throw new Error(`Scoring weights must sum to 1.0, got ${t}`);return e}getScoreBreakdown(e){const t=this.calculatePlatformScore(e.platform),r=this.calculateFilesScore(e),n=this.calculateDependenciesScore(e),o=this.calculateEnvironmentScore(e),a=this.calculateCodeBlocksScore(),i=this.calculateGitHubScore(e.platform),l={platform:t*this.weights.platform,files:r*this.weights.files,dependencies:n*this.weights.dependencies,environment:o*this.weights.environment,codeBlocks:a*this.weights.codeBlocks,github:i*this.weights.githubFeatures},h=Object.values(l).reduce((k,$)=>k+$,0);return{total:this.createScore(h),breakdown:l}}}class D{config;sessionId;breadcrumbs=[];performanceBuffer=[];userId;constructor(e){this.config=e,this.sessionId=this.generateSessionId(),this.initializeErrorHandling(),this.initializePerformanceTracking(),this.startPerformanceReporting()}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}initializeErrorHandling(){this.config.enableErrorReporting&&typeof window<"u"&&(window.addEventListener("error",e=>{this.reportError(new Error(e.message),{action:"global_error",url:e.filename,line:e.lineno,column:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.reportError(new Error(`Unhandled Promise Rejection: ${e.reason}`),{action:"unhandled_promise_rejection"})}))}initializePerformanceTracking(){this.config.enablePerformanceTracking&&(typeof window<"u"&&typeof performance<"u"&&performance.timing&&window.addEventListener("load",()=>{setTimeout(()=>{this.trackPerformanceMetrics()},1e3)}),this.trackExtensionMetrics())}trackExtensionMetrics(){if(chrome?.runtime){const e=performance.now();chrome.runtime.connect({name:"telemetry"});const t=performance.now()-e;this.recordMetric({name:"service_worker_connection_time",value:t,unit:"ms",timestamp:Date.now()})}if(typeof document<"u"&&document.readyState==="loading"){const e=performance.now();document.addEventListener("DOMContentLoaded",()=>{const t=performance.now()-e;this.recordMetric({name:"content_script_injection_time",value:t,unit:"ms",timestamp:Date.now()})})}}trackPerformanceMetrics(){const e=performance.timing,t=performance.navigation;if([{name:"dom_content_loaded",value:e.domContentLoadedEventEnd-e.navigationStart,unit:"ms"},{name:"page_load_complete",value:e.loadEventEnd-e.navigationStart,unit:"ms"},{name:"dns_lookup_time",value:e.domainLookupEnd-e.domainLookupStart,unit:"ms"},{name:"tcp_connection_time",value:e.connectEnd-e.connectStart,unit:"ms"}].forEach(n=>{n.value>0&&this.recordMetric({...n,timestamp:Date.now(),metadata:{navigationType:t.type,redirectCount:t.redirectCount}})}),performance.memory){const n=performance.memory;this.recordMetric({name:"memory_used",value:n.usedJSHeapSize,unit:"bytes",timestamp:Date.now()}),this.recordMetric({name:"memory_limit",value:n.jsHeapSizeLimit,unit:"bytes",timestamp:Date.now()})}}startPerformanceReporting(){setInterval(()=>{this.performanceBuffer.length>0&&this.flushPerformanceMetrics()},3e4)}async recordMetric(e){if(this.config.enablePerformanceTracking&&!(Math.random()>this.config.sampleRate)){this.performanceBuffer.push(e);try{const r=(await chrome.storage.local.get("telemetry_metrics")).telemetry_metrics||[];r.push(e),r.length>100&&r.shift(),await chrome.storage.local.set({telemetry_metrics:r})}catch(t){console.warn("Failed to store telemetry metric:",t)}}}async reportError(e,t={}){if(!this.config.enableErrorReporting)return;const r={error:{name:e.name,message:e.message,stack:e.stack||""},context:{userAgent:navigator.userAgent,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,extensionVersion:this.getExtensionVersion(),...t},stackTrace:e.stack||"",breadcrumbs:[...this.breadcrumbs]};try{const o=(await chrome.storage.local.get("telemetry_errors")).telemetry_errors||[];o.push(r),o.length>50&&o.shift(),await chrome.storage.local.set({telemetry_errors:o})}catch(n){console.warn("Failed to store error report:",n)}this.sendErrorReport(r)}async trackUserEvent(e,t={}){if(!this.config.enableUserAnalytics)return;const r={event:e,properties:{...t,extensionVersion:this.getExtensionVersion(),environment:this.config.environment},timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId};try{const o=(await chrome.storage.local.get("telemetry_events")).telemetry_events||[];o.push(r),o.length>200&&o.shift(),await chrome.storage.local.set({telemetry_events:o})}catch(n){console.warn("Failed to store user event:",n)}this.sendUserEvent(r)}async trackExtraction(e,t={}){return this.trackUserEvent(`extraction_${e}`,t)}async track(e,t={}){return this.trackUserEvent(e,t)}addBreadcrumb(e){const t=`${new Date().toISOString()}: ${e}`;this.breadcrumbs.push(t),this.breadcrumbs.length>20&&this.breadcrumbs.shift()}setUserId(e){this.userId=e}async flushPerformanceMetrics(){if(this.performanceBuffer.length===0)return;const e=[...this.performanceBuffer];this.performanceBuffer=[];try{await this.sendBatch("metrics",e)}catch(t){console.warn("Failed to send performance metrics:",t),this.performanceBuffer.unshift(...e)}}async sendErrorReport(e){try{await this.sendBatch("errors",[e])}catch(t){console.warn("Failed to send error report:",t)}}async sendUserEvent(e){try{await this.sendBatch("events",[e])}catch(t){console.warn("Failed to send user event:",t)}}async sendBatch(e,t){if(!this.config.endpoint)return;const r={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,environment:this.config.environment},n=await fetch(`${this.config.endpoint}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`)}getExtensionVersion(){try{return chrome.runtime.getManifest().version}catch{return"unknown"}}startTimer(e){const t=performance.now();return()=>{const r=performance.now()-t;this.recordMetric({name:e,value:r,unit:"ms",timestamp:Date.now()})}}trackMemoryUsage(e){if(performance.memory){const t=performance.memory;this.recordMetric({name:"memory_usage_snapshot",value:t.usedJSHeapSize,unit:"bytes",timestamp:Date.now(),metadata:{context:e}})}}trackNetworkRequest(e,t,r,n){this.recordMetric({name:"network_request",value:r,unit:"ms",timestamp:Date.now(),metadata:{url:e.replace(/[?#].*/,""),method:t,status:n,success:n>=200&&n<400}})}}const I=()=>{const s=typeof process<"u"&&process.env?.NODE_ENV||"production",e=typeof process<"u"&&process.env?.TELEMETRY_ENDPOINT||void 0,t=s==="development",r=s==="production",n={environment:t?"development":r?"production":"staging",enableErrorReporting:r,enablePerformanceTracking:!0,enableUserAnalytics:r,sampleRate:t?1:.1,endpoint:e};return new D(n)},x=async(s,e)=>{const t=m.startTimer(s);try{const r=await e();return t(),r}catch(r){throw t(),r}},m=I(),O={maxAttempts:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2,timeout:3e4};class y{static instance=null;retryAttempts=new Map;retryTimers=new Map;static getInstance(){return y.instance||(y.instance=new y),y.instance}async withRecovery(e,t){const{operationId:r,context:n="unknown"}=t,o={...O,...t.retryConfig};let a=null;const i=Date.now();this.clearRetryTimer(r);for(let l=1;l<=o.maxAttempts;l++)try{if(o.timeout&&Date.now()-i>o.timeout)throw new c(u.EXTRACTION_TIMEOUT,"Operation timeout exceeded",{context:{timestamp:Date.now()}});const h=await this.executeWithTimeout(e,o.timeout);return this.retryAttempts.delete(r),l>1&&m.track("error_boundary",{type:"recovery_success",operationId:r,context:n,attemptsRequired:l,duration:Date.now()-i}),h}catch(h){if(a=h instanceof c?h:c.fromUnknown(h,{timestamp:Date.now()}),console.warn(`[${n}] Attempt ${l}/${o.maxAttempts} failed:`,{error:a.code,message:a.message,severity:a.severity}),this.retryAttempts.set(r,l),!this.shouldRetry(a,l,o.maxAttempts))break;const k=this.calculateDelay(l,o);l<o.maxAttempts&&await this.delay(k)}if(t.fallbackOperation)try{console.log(`[${n}] Trying fallback operation after ${o.maxAttempts} failed attempts`);const l=await t.fallbackOperation();return m.track("error_boundary",{type:"fallback_success",operationId:r,context:n,originalError:a?.code,duration:Date.now()-i}),l}catch(l){const h=l instanceof c?l:c.fromUnknown(l,{timestamp:Date.now()});if(m.track("error_boundary",{type:"fallback_failed",operationId:r,context:n,originalError:a?.code,fallbackError:h.code,duration:Date.now()-i}),this.compareSeverity(h.severity,a?.severity||p.LOW)>=0)throw h}throw this.retryAttempts.delete(r),m.track("error_boundary",{type:"recovery_failed",operationId:r,context:n,finalError:a?.code,attemptsUsed:o.maxAttempts,duration:Date.now()-i}),a||new c(u.UNKNOWN_ERROR,"Operation failed after all recovery attempts")}async handleError(e,t){const r=e instanceof c?e:c.fromUnknown(e);switch(m.track("error_boundary",{type:"error_handled",operationId:t.operationId,operationType:t.operationType,errorCode:r.code,severity:r.severity,recoveryStrategy:r.recoveryStrategy}),r.recoveryStrategy){case f.RETRY:return{recovered:!1,suggestion:"This issue is usually temporary. Try the operation again.",actions:["Retry now","Wait 30 seconds and retry","Refresh page and retry"]};case f.FALLBACK:return{recovered:await this.attemptFallbackRecovery(r,t),suggestion:"Switched to alternative method due to the issue.",actions:["Continue with limited functionality","Try full operation later","Check settings"]};case f.GRACEFUL_DEGRADATION:return{recovered:!0,suggestion:"Continuing with reduced functionality to work around the issue.",actions:["Continue anyway","Try on different page","Report issue"]};case f.USER_ACTION_REQUIRED:return{recovered:!1,suggestion:"User action is required to resolve this issue.",actions:r.recoveryActions};case f.RESTART_REQUIRED:return{recovered:!1,suggestion:"Extension restart is required to fix this issue.",actions:["Restart browser","Reload extension","Check for updates"]};default:return{recovered:!1,suggestion:"This error requires manual resolution.",actions:["Try again later","Check browser console","Report issue"]}}}getRetryCount(e){return this.retryAttempts.get(e)||0}clearRetryState(e){this.retryAttempts.delete(e),this.clearRetryTimer(e)}getRecoveryRecommendations(e){const t=e instanceof c?e:c.fromUnknown(e);switch(this.categorizeError(t.code)){case"platform":return{immediate:["Refresh the page","Wait for page to fully load","Try on supported platform"],followUp:["Check internet connection","Clear browser cache","Update browser"],prevention:["Use supported development platforms","Ensure stable internet connection"]};case"permissions":return{immediate:["Check extension permissions","Grant required permissions","Reload extension"],followUp:["Restart browser","Reinstall extension if needed"],prevention:["Keep extension permissions up to date","Avoid revoking permissions"]};case"performance":return{immediate:["Close unused tabs","Wait and retry","Reduce complexity"],followUp:["Restart browser","Check system resources"],prevention:["Limit concurrent operations","Use smaller code sections"]};case"network":return{immediate:["Check internet connection","Retry in a moment","Try different network"],followUp:["Clear browser cache","Disable VPN if used"],prevention:["Use stable internet connection","Avoid peak usage times"]};default:return{immediate:t.recoveryActions,followUp:["Restart browser","Check for updates"],prevention:["Keep extension updated","Use supported browsers"]}}}async executeWithTimeout(e,t){return t?Promise.race([e(),new Promise((r,n)=>{setTimeout(()=>{n(new c(u.EXTRACTION_TIMEOUT,`Operation timed out after ${t}ms`))},t)})]):e()}shouldRetry(e,t,r){return t>=r||e.severity===p.CRITICAL||e.recoveryStrategy===f.USER_ACTION_REQUIRED||e.recoveryStrategy===f.NO_RECOVERY?!1:![u.CHROME_PERMISSIONS_MISSING,u.PLATFORM_NOT_SUPPORTED,u.CONTENT_SCRIPT_CSP_VIOLATION].includes(e.code)}calculateDelay(e,t){const r=t.baseDelay*Math.pow(t.backoffFactor,e-1),n=Math.random()*.1*r;return Math.min(r+n,t.maxDelay)}async delay(e){return new Promise(t=>setTimeout(t,e))}clearRetryTimer(e){const t=this.retryTimers.get(e);t&&(clearTimeout(t),this.retryTimers.delete(e))}compareSeverity(e,t){const r=[p.LOW,p.MEDIUM,p.HIGH,p.CRITICAL];return r.indexOf(e)-r.indexOf(t)}async attemptFallbackRecovery(e,t){switch(e.code){case u.CLIPBOARD_PERMISSION_DENIED:return!0;case u.PLATFORM_DOM_ACCESS_DENIED:return!1;case u.CHROME_STORAGE_QUOTA_EXCEEDED:try{return!0}catch{return!1}default:return!1}}categorizeError(e){return e.includes("PLATFORM")?"platform":e.includes("PERMISSION")||e.includes("ACCESS")?"permissions":e.includes("TIMEOUT")||e.includes("MEMORY")||e.includes("QUOTA")?"performance":e.includes("NETWORK")||e.includes("REQUEST")?"network":"unknown"}}const P=y.getInstance(),L={timeout:5e3,includeContent:!0,maxFileSize:1e5,maxFiles:50};class N{options;scorer;startTime;constructor(e=L){this.options=e,this.scorer=new M,this.startTime=performance.now()}async extract(){return P.withRecovery(async()=>{const t=new E().getCached()||"unknown";m.trackExtraction("start",{platform:t});const r=new Promise((o,a)=>{setTimeout(()=>{a(new c(u.EXTRACTION_TIMEOUT,`Extraction timeout after ${this.options.timeout}ms`,{context:{timestamp:Date.now()}}))},this.options.timeout)}),n=await x("extraction_total",async()=>Promise.race([this.performExtraction(),r]));return m.trackExtraction("complete",{platform:n.context.platform,score:n.score,duration:n.context.metadata.extractionTime,fileCount:n.context.structure.totalFiles}),{success:!0,faf:n}},{operationId:"faf_extraction",retryConfig:{maxAttempts:2,baseDelay:100,maxDelay:500},fallbackOperation:async()=>{const e=performance.now()-this.startTime;return m.trackExtraction("fallback",{duration:e}),{success:!1,error:"Extraction failed - minimal context available",code:"FALLBACK_MODE"}},context:"FAFEngine.extract"}).catch(e=>{const t=performance.now()-this.startTime,r=e instanceof c?e:c.fromUnknown(e);return m.trackExtraction("error",{error:r.message,code:r.code,duration:t}),{success:!1,error:r.userMessage,code:r.code}})}async performExtraction(){try{const e=new E,t=await x("platform_detection",async()=>e.detect(),50);m.track("platform_detected",{platform:t});const[r,n,o]=await Promise.all([this.extractStructureWithErrorHandling(t),this.extractDependenciesWithErrorHandling(t),this.extractEnvironmentWithErrorHandling(t)]),a={platform:t,structure:r,dependencies:n,environment:o,metadata:this.createMetadata()},i=this.scorer.calculateScore(a),l={...a,score:i};return this.generateFAF(l)}catch(e){throw e instanceof c?e:new c(u.EXTRACTION_FAILED,"Failed to perform context extraction",{context:{error:e instanceof Error?e.message:"Unknown error"}})}}async extractStructureWithErrorHandling(e){return x("structure_extraction",async()=>{try{return await this.extractStructure(e)}catch(t){throw new c(u.STRUCTURE_EXTRACTION_FAILED,"Failed to extract project structure",{context:{platform:e,error:t instanceof Error?t.message:"Unknown error"}})}})}async extractDependenciesWithErrorHandling(e){return x("dependencies_extraction",async()=>{try{return await this.extractDependencies(e)}catch(t){throw new c(u.DEPENDENCIES_EXTRACTION_FAILED,"Failed to extract dependency information",{context:{platform:e,error:t instanceof Error?t.message:"Unknown error"}})}})}async extractEnvironmentWithErrorHandling(e){return x("environment_extraction",async()=>{try{return await this.extractEnvironment(e)}catch(t){throw new c(u.ENVIRONMENT_EXTRACTION_FAILED,"Failed to extract environment information",{context:{platform:e,error:t instanceof Error?t.message:"Unknown error"}})}})}async extractStructure(e){let t=[];switch(e){case"monaco":t=b.extractMonacoFiles();break;case"codemirror":t=b.extractCodeMirrorFiles();break;case"vscode-web":t=b.extractVSCodeWebFiles();break;default:t=[]}const r=t.filter(a=>a.size<=this.options.maxFileSize).slice(0,this.options.maxFiles),n=this.extractDirectories(r),o=this.detectEntryPoints(r);return{files:r,directories:n,entryPoints:o,totalFiles:r.length,totalLines:r.reduce((a,i)=>a+i.lines,0)}}async extractDependencies(e){const t=this.detectRuntime(),r=[];let n=null;return e==="github"&&d.hasPackageJson(),{runtime:t,packages:r,lockFile:n}}async extractEnvironment(e){const t=[],r=[];if(e==="github"){const n=d.getBonusFeatures();n.includes("env-file")&&r.push(".env"),n.includes("config-files")&&r.push("webpack.config.js","vite.config.ts")}return{variables:t,configFiles:r}}detectRuntime(){const e=v.getCodeLanguages();let t="unknown",r="unknown",n="unknown";return e.includes("typescript")||e.includes("ts")?t="TypeScript":e.includes("javascript")||e.includes("js")?t="JavaScript":e.includes("python")||e.includes("py")?t="Python":e.includes("java")?t="Java":e.length>0&&(t=e[0]||"Unknown"),document.querySelector('a[href*="pnpm-lock.yaml"]')?n="pnpm":document.querySelector('a[href*="yarn.lock"]')?n="yarn":document.querySelector('a[href*="package-lock.json"]')?n="npm":document.querySelector('a[href*="bun.lockb"]')&&(n="bun"),{language:t,version:r,packageManager:n}}extractDirectories(e){const t=new Set;return e.forEach(r=>{const n=r.path.split("/");for(let o=1;o<n.length;o++){const a=n.slice(0,o).join("/");a&&t.add(a)}}),Array.from(t).sort()}detectEntryPoints(e){const t=[],r=[/^index\.(js|ts|jsx|tsx)$/,/^main\.(js|ts|jsx|tsx)$/,/^app\.(js|ts|jsx|tsx)$/,/^server\.(js|ts)$/,/^index\.html$/,/^package\.json$/,/^README\.(md|rst|txt)$/i];return e.forEach(n=>{const o=n.path.split("/").pop()??"";r.some(a=>a.test(o))&&t.push(n.path)}),t}createMetadata(){return{extractionTime:performance.now()-this.startTime,version:"1.0.0",timestamp:new Date().toISOString(),url:window.location.href,userAgent:navigator.userAgent}}generateFAF(e){const t=this.generateSummary(e),r=this.generateAIInstructions(e),n=this.generateChecksum(e);return{version:"1.0.0",generated:new Date().toISOString(),score:e.score,context:e,summary:t,ai_instructions:r,checksum:n,compressed:!1,size:JSON.stringify(e).length}}generateSummary(e){const t=e.score,r=e.structure.totalFiles,n=e.structure.totalLines;let o=`${e.platform} project with ${t}% context confidence.`;return r>0&&(o+=` Contains ${r} files (${n} lines total).`),e.dependencies.runtime.language!=="unknown"&&(o+=` Primary language: ${e.dependencies.runtime.language}.`),o}generateAIInstructions(e){const t=e.score;let n=`Context extracted from ${e.platform} with ${t}% confidence. `;return t>=80?(n+="High confidence - Full project context available. ",n+="You have access to complete file structure, dependencies, and configuration. ",n+="Provide detailed, project-specific assistance."):t>=50?(n+="Medium confidence - Partial context available. ",n+="Basic project information is present but some details may be incomplete. ",n+="Ask for clarification on specific implementation details if needed."):(n+="Low confidence - Limited context available. ",n+="Only basic page information extracted. ",n+="Request additional context or code snippets for better assistance."),n}generateChecksum(e){const t=JSON.stringify(e);let r=0;for(let n=0;n<t.length;n++){const o=t.charCodeAt(n);r=(r<<5)-r+o,r=r&r}return Math.abs(r).toString(36).padStart(8,"0").substring(0,8)}detectPlatform(){return console.warn("⚠️ FAFEngine.detectPlatform() is deprecated. Use async extraction instead."),new E().detectPlatform()}}class g extends Error{constructor(e,t){super(e),this.code=t,this.name="ClipboardError"}}class C{static async copyFAFContent(e){const t=this.formatFAFContent(e);await this.writeToClipboard(t)}static async writeToClipboard(e){try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(e);return}this.execCommandFallback(e)}catch(t){throw t instanceof Error&&t.name==="NotAllowedError"?new g("Clipboard access denied","PERMISSION_DENIED"):new g(t instanceof Error?t.message:"Failed to write to clipboard","WRITE_FAILED")}}static execCommandFallback(e){const t=document.createElement("textarea");try{if(t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.top="-9999px",t.style.opacity="0",t.setAttribute("readonly",""),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length),!document.execCommand("copy"))throw new g("execCommand copy failed","WRITE_FAILED")}finally{t.parentNode&&t.parentNode.removeChild(t)}}static formatFAFContent(e){const t=e.score,r=this.getConfidenceMessage(t);return`.faf Context
URL: ${e.context.metadata.url}
Platform: ${e.context.platform}
Score: ${t}%
Extracted: ${e.generated}

Detection
Code blocks found: ${this.getCodeBlockCount(e)}
Package.json detected: ${this.hasPackageJson(e)}
Environment vars: ${this.hasEnvironmentVars(e)}

AI Instructions
Context extracted from ${e.context.platform} with ${t}% confidence.
${r}

## Summary
${e.summary}

## Project Structure
Files: ${e.context.structure.totalFiles}
Lines: ${e.context.structure.totalLines}
Entry Points: ${e.context.structure.entryPoints.join(", ")||"None detected"}

## Dependencies
Runtime: ${e.context.dependencies.runtime.language} ${e.context.dependencies.runtime.version}
Package Manager: ${e.context.dependencies.runtime.packageManager}
Packages: ${e.context.dependencies.packages.length}

## Raw Context
${JSON.stringify(e.context,null,2)}`}static getConfidenceMessage(e){return e>=80?"High confidence - Full project context available with complete file structure and dependencies.":e>=50?"Medium confidence - Partial context available with basic project information.":"Low confidence - Limited context available, basic page analysis only."}static getCodeBlockCount(e){return e.context.structure.files.length>0?e.context.structure.files.length:0}static hasPackageJson(e){return e.context.dependencies.packages.length>0||e.context.structure.files.some(t=>t.path.includes("package.json"))}static hasEnvironmentVars(e){return e.context.environment.variables.length>0||e.context.environment.configFiles.some(t=>t.includes(".env"))}static validateFAFContent(e){if(!e.version)throw new g("Invalid FAF file: missing version","FORMAT_ERROR");if(!e.context)throw new g("Invalid FAF file: missing context","FORMAT_ERROR");if(!e.context.metadata?.url)throw new g("Invalid FAF file: missing URL","FORMAT_ERROR");const t=e.score;if(!Number.isInteger(t)||t<0||t>100)throw new g("Invalid FAF file: invalid score","FORMAT_ERROR")}static getContentPreview(e){const t=this.formatFAFContent(e);return t.length>200?`${t.substring(0,200)}...`:t}}class A{static sendMessage(e){return new Promise(t=>{try{chrome.runtime.sendMessage(e,r=>{if(chrome.runtime.lastError){const n=chrome.runtime.lastError.message||"Unknown runtime error";if(n.includes("Could not establish connection")||n.includes("No such extension")||n.includes("Extension context invalidated")||n.includes("Receiving end does not exist")){t();return}console.warn("FAF: Runtime warning (non-blocking):",n),t();return}t()})}catch(r){console.warn("FAF: Messaging warning (non-blocking):",r),t()}})}static onMessage(e){chrome.runtime.onMessage.addListener(e)}static onInstalled(e){chrome.runtime.onInstalled.addListener(e)}}class j{initialized=!1;extracting=!1;engine;constructor(){this.engine=new N}isInitialized(){return this.initialized}setInitialized(e){this.initialized=e}isExtracting(){return this.extracting}setExtracting(e){this.extracting=e}getEngine(){return this.engine}}class w extends Error{constructor(e,t){super(e),this.code=t,this.name="ContentScriptError"}}class U{state=new j;async initialize(){if(!this.state.isInitialized())try{A.onMessage(this.handleMessage.bind(this)),this.state.setInitialized(!0),await this.injectVisualIndicators()}catch(e){throw new w(`Initialization failed: ${e instanceof Error?e.message:"Unknown error"}`,"INITIALIZATION_FAILED")}}handleMessage(e,t,r){try{if(!this.isValidMessage(e))return r({success:!1,error:"Invalid message format"}),!0;switch(e.type){case"EXTRACT_CONTEXT":return this.handleExtractContext(e).then(n=>r(n)).catch(n=>{r({success:!1,error:n instanceof Error?n.message:"Extraction failed"})}),!0;default:return r({success:!1,error:`Unknown message type: ${e.type}`}),!0}}catch(n){const o=n instanceof Error?n.message:"Message handling failed";return r({success:!1,error:o}),!0}}async handleExtractContext(e){if(this.state.isExtracting())throw new w("Extraction already in progress","EXTRACTION_FAILED");this.state.setExtracting(!0);try{const t=await this.state.getEngine().extract();if(!t.success)throw new w(`Extraction failed: ${t.error}`,"EXTRACTION_FAILED");const r=!0;return await A.sendMessage({type:"CONTEXT_EXTRACTED",payload:t,timestamp:Date.now(),source:"content"}),this.showSuccessNotification(t.faf.score,r),t}catch(t){throw A.sendMessage({type:"ERROR",payload:{error:t instanceof Error?t.message:"Unknown extraction error",code:t instanceof w?t.code:"UNKNOWN_ERROR",...t instanceof Error&&t.stack?{stack:t.stack}:{}},timestamp:Date.now(),source:"content"}).catch(r=>{console.warn("Failed to send error to background:",r)}),t}finally{this.state.setExtracting(!1)}}async copyToClipboard(e){try{return C.validateFAFContent(e),await C.copyFAFContent(e),!0}catch(t){if(t instanceof g&&t.code==="PERMISSION_DENIED")return console.warn("⚠️ Clipboard access denied. Context extracted successfully but not copied to clipboard."),console.warn("💡 The extension may need to be reloaded, or the page may need a user interaction first."),!1;throw t instanceof g?new w(`Clipboard operation failed: ${t.message}`,"CLIPBOARD_FAILED"):new w(`Unexpected clipboard error: ${t instanceof Error?t.message:"Unknown error"}`,"CLIPBOARD_FAILED")}}showSuccessNotification(e,t=!0){try{const r=document.createElement("div");r.className="faf-success-notification";const n=t?"Copied to clipboard!":"Manual copy needed - check console",o=t?"⚡️":"⚠️",a=t?"#00FF41":"#FF6B35";if(r.innerHTML=`
        <div class="faf-notification-content">
          <span class="faf-notification-icon">${o}</span>
          <span class="faf-notification-text">Context extracted (${e}%) - ${n}</span>
        </div>
      `,Object.assign(r.style,{position:"fixed",top:"20px",left:"20px",background:a,color:t?"#0A0A0A":"#FFF8F0",padding:"12px 16px",borderRadius:"8px",fontFamily:"system-ui, sans-serif",fontSize:"14px",fontWeight:"600",zIndex:"2147483647",boxShadow:t?"0 4px 12px rgba(0, 255, 65, 0.3)":"0 4px 12px rgba(255, 107, 53, 0.3)",animation:"fafSlideIn 0.3s ease-out"}),!document.querySelector("#faf-notification-styles")){const i=document.createElement("style");i.id="faf-notification-styles",i.textContent=`
          @keyframes fafSlideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `,document.head.appendChild(i)}document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},3e3)}catch(r){console.warn("Failed to show success notification:",r)}}async injectVisualIndicators(){try{const t=new(await Promise.resolve().then(()=>S)).PlatformDetector().getCached()||"unknown";t==="github"?this.injectGitHubBadge():(t==="monaco"||t==="codemirror")&&this.injectEditorWidget()}catch(e){console.warn("Failed to inject visual indicators:",e)}}injectGitHubBadge(){try{const e=document.querySelector("[data-hpc], .repository-content");if(!e)return;const t=document.createElement("div");t.className="faf-github-badge",t.innerHTML=`
        <span style="font-size: 16px;">⚡️</span>
        <span style="margin-left: 6px; font-weight: 600;">FAF Ready</span>
      `,Object.assign(t.style,{display:"inline-flex",alignItems:"center",padding:"4px 12px",background:"#FF6B35",color:"#FFF8F0",borderRadius:"16px",fontSize:"12px",cursor:"pointer",margin:"8px",transition:"transform 0.2s ease"}),t.addEventListener("click",()=>{this.handleExtractContext({type:"EXTRACT_CONTEXT",timestamp:Date.now(),source:"content"}).catch(r=>{console.error("Badge extraction failed:",r)})}),t.addEventListener("mouseenter",()=>{t.style.transform="scale(1.05)"}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1)"}),e.appendChild(t)}catch(e){console.warn("Failed to inject GitHub badge:",e)}}injectEditorWidget(){try{const e=document.createElement("div");e.className="faf-editor-widget",e.innerHTML=`
        <div style="font-size: 20px;">⚡️</div>
        <div style="font-size: 10px; margin-top: 2px;">FAF</div>
      `,Object.assign(e.style,{position:"fixed",top:"20px",right:"20px",width:"48px",height:"48px",background:"rgba(255, 107, 53, 0.9)",color:"#FFF8F0",borderRadius:"50%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",cursor:"pointer",zIndex:"999998",transition:"all 0.2s ease",fontFamily:"system-ui, sans-serif",fontWeight:"600"}),e.addEventListener("click",()=>{this.handleExtractContext({type:"EXTRACT_CONTEXT",timestamp:Date.now(),source:"content"}).catch(t=>{console.error("Widget extraction failed:",t)})}),e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.1)",e.style.background="#FF6B35"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)",e.style.background="rgba(255, 107, 53, 0.9)"}),document.body.appendChild(e)}catch(e){console.warn("Failed to inject editor widget:",e)}}isValidMessage(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.type=="string"&&typeof t.timestamp=="number"&&typeof t.source=="string"}}const _=new U;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{_.initialize().catch(s=>{console.error("FAF Content Script initialization failed:",s)})}):_.initialize().catch(s=>{console.error("FAF Content Script initialization failed:",s)})})();
