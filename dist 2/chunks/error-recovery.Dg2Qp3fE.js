var i=(n=>(n.PLATFORM_DETECTION_TIMEOUT="FAF_1001",n.PLATFORM_DETECTION_FAILED="FAF_1002",n.PLATFORM_NOT_SUPPORTED="FAF_1003",n.PLATFORM_DOM_ACCESS_DENIED="FAF_1004",n.EXTRACTION_TIMEOUT="FAF_1101",n.EXTRACTION_FAILED="FAF_1102",n.EXTRACTION_INVALID_DATA="FAF_1103",n.EXTRACTION_PERMISSION_DENIED="FAF_1104",n.EXTRACTION_RATE_LIMITED="FAF_1105",n.CHROME_TAB_ACCESS_DENIED="FAF_1201",n.CHROME_STORAGE_QUOTA_EXCEEDED="FAF_1202",n.CHROME_MESSAGING_FAILED="FAF_1203",n.CHROME_PERMISSIONS_MISSING="FAF_1204",n.CHROME_RUNTIME_ERROR="FAF_1205",n.CHROME_TAB_NOT_FOUND="FAF_1206",n.CHROME_API_UNAVAILABLE="FAF_1207",n.CHROME_MESSAGE_FAILED="FAF_1208",n.CHROME_SCRIPTING_FAILED="FAF_1209",n.CHROME_STORAGE_ERROR="FAF_1210",n.SERVICE_WORKER_INIT_FAILED="FAF_1301",n.SERVICE_WORKER_MESSAGE_FAILED="FAF_1302",n.SERVICE_WORKER_MEMORY_PRESSURE="FAF_1303",n.SERVICE_WORKER_TIMEOUT="FAF_1304",n.POPUP_LOAD_FAILED="FAF_1401",n.POPUP_ACTION_FAILED="FAF_1402",n.POPUP_DATA_CORRUPT="FAF_1403",n.CLIPBOARD_PERMISSION_DENIED="FAF_1501",n.CLIPBOARD_WRITE_FAILED="FAF_1502",n.CLIPBOARD_DATA_TOO_LARGE="FAF_1503",n.NETWORK_REQUEST_FAILED="FAF_1601",n.NETWORK_TIMEOUT="FAF_1602",n.NETWORK_RATE_LIMITED="FAF_1603",n.CONTENT_SCRIPT_INJECTION_FAILED="FAF_1701",n.CONTENT_SCRIPT_DOM_BLOCKED="FAF_1702",n.CONTENT_SCRIPT_CSP_VIOLATION="FAF_1703",n.UNKNOWN_ERROR="FAF_1901",n.SYSTEM_OVERLOAD="FAF_1902",n.CONFIGURATION_ERROR="FAF_1903",n.DEPENDENCY_ERROR="FAF_1904",n))(i||{}),d=(n=>(n.LOW="low",n.MEDIUM="medium",n.HIGH="high",n.CRITICAL="critical",n))(d||{}),u=(n=>(n.RETRY="retry",n.FALLBACK="fallback",n.GRACEFUL_DEGRADATION="degrade",n.USER_ACTION_REQUIRED="user",n.RESTART_REQUIRED="restart",n.NO_RECOVERY="none",n))(u||{});class a extends Error{code;severity;userMessage;technicalDetails;recoveryStrategy;recoveryActions;context;timestamp;constructor(e,t,r={}){super(t,{cause:r.cause}),this.name="FAFError",this.code=e,this.timestamp=Date.now();const s=_.getErrorInfo(e);this.severity=s.severity,this.recoveryStrategy=s.recoveryStrategy,this.recoveryActions=s.recoveryActions,this.userMessage=r.userMessage||s.userMessage,this.technicalDetails=r.technicalDetails,this.context={timestamp:this.timestamp,platform:r.context?.platform,url:r.context?.url||(typeof window<"u"?window.location.href:void 0),userAgent:r.context?.userAgent||(typeof navigator<"u"?navigator.userAgent:void 0),sessionId:r.context?.sessionId},this.trackError()}static fromUnknown(e,t){if(e instanceof a)return e;if(e instanceof Error){let s="FAF_1901";return e.message.includes("timeout")?s="FAF_1101":e.message.includes("permission")?s="FAF_1204":e.message.includes("DOM")||e.message.includes("document")?s="FAF_1004":e.message.includes("quota")&&(s="FAF_1202"),new a(s,e.message,{cause:e,technicalDetails:e.stack,context:t})}const r=typeof e=="string"?e:String(e);return new a("FAF_1901",r,{context:t})}isRecoverable(){return this.recoveryStrategy!=="none"}requiresUserAction(){return this.recoveryStrategy==="user"}getDisplayInfo(){return{title:this.getErrorTitle(),message:this.userMessage,actions:this.recoveryActions,severity:this.severity,canRetry:this.recoveryStrategy==="retry"}}toJSON(){return{code:this.code,severity:this.severity,message:this.message,userMessage:this.userMessage,technicalDetails:this.technicalDetails,recoveryStrategy:this.recoveryStrategy,recoveryActions:this.recoveryActions,context:this.context,timestamp:this.timestamp,stack:this.stack}}getErrorTitle(){return{low:"Minor Issue",medium:"Issue Detected",high:"Extraction Problem",critical:"Critical Error"}[this.severity]}trackError(){try{console.warn(`[FAF Error ${this.code}] ${this.severity}: ${this.message}`)}catch{}}}class _{static errorDefinitions=new Map([["FAF_1001",{code:"FAF_1001",severity:"medium",message:"Platform detection timed out",userMessage:"Unable to detect the current platform quickly enough. The page may be loading slowly.",recoveryStrategy:"retry",recoveryActions:["Wait for page to load completely","Refresh the page","Try extraction again"]}],["FAF_1003",{code:"FAF_1003",severity:"medium",message:"Platform is not supported",userMessage:"This website is not currently supported by FAF. We support GitHub, Monaco Editor, CodeMirror, and other development platforms.",recoveryStrategy:"degrade",recoveryActions:["Try on a supported platform","Copy code manually","Request platform support"]}],["FAF_1004",{code:"FAF_1004",severity:"high",message:"DOM access denied",userMessage:"Cannot access page content due to security restrictions. This may be due to strict Content Security Policy.",recoveryStrategy:"user",recoveryActions:["Refresh the page","Check browser security settings","Try on a different page"]}],["FAF_1101",{code:"FAF_1101",severity:"medium",message:"Context extraction timed out",userMessage:"Extraction took longer than expected. The page may have complex content or be loading slowly.",recoveryStrategy:"retry",recoveryActions:["Wait a moment and try again","Refresh the page","Check internet connection"]}],["FAF_1104",{code:"FAF_1104",severity:"high",message:"Permission denied for extraction",userMessage:"FAF does not have permission to access this page. Please check extension permissions.",recoveryStrategy:"user",recoveryActions:["Check extension permissions in browser settings","Reload the extension","Refresh the page"]}],["FAF_1201",{code:"FAF_1201",severity:"high",message:"Chrome tab access denied",userMessage:"Cannot access the current tab. Please ensure FAF has the necessary permissions.",recoveryStrategy:"user",recoveryActions:["Grant tab permissions to FAF","Reload the extension","Check browser security settings"]}],["FAF_1202",{code:"FAF_1202",severity:"medium",message:"Chrome storage quota exceeded",userMessage:"Extension storage is full. Some data may not be saved.",recoveryStrategy:"fallback",recoveryActions:["Clear extension data","Restart browser","Continue without saving preferences"]}],["FAF_1204",{code:"FAF_1204",severity:"critical",message:"Required Chrome permissions missing",userMessage:"FAF is missing required permissions to function properly.",recoveryStrategy:"user",recoveryActions:["Go to chrome://extensions/","Find FAF extension","Grant required permissions"]}],["FAF_1206",{code:"FAF_1206",severity:"medium",message:"No active tab found",userMessage:"No active tab detected. Please open a supported page.",recoveryStrategy:"user",recoveryActions:["Open a supported website","Refresh the current page","Try a different tab"]}],["FAF_1207",{code:"FAF_1207",severity:"high",message:"Chrome API unavailable",userMessage:"Chrome extension APIs are not available.",recoveryStrategy:"restart",recoveryActions:["Restart browser","Check Chrome version","Reinstall extension"]}],["FAF_1208",{code:"FAF_1208",severity:"medium",message:"Chrome message failed",userMessage:"Failed to communicate with the page. Please try again.",recoveryStrategy:"retry",recoveryActions:["Try again","Refresh the page","Check page permissions"]}],["FAF_1209",{code:"FAF_1209",severity:"high",message:"Script injection failed",userMessage:"Unable to inject required scripts into the page.",recoveryStrategy:"fallback",recoveryActions:["Refresh the page","Try a different page","Check site permissions"]}],["FAF_1210",{code:"FAF_1210",severity:"medium",message:"Chrome storage error",userMessage:"Unable to save data. Some features may not persist.",recoveryStrategy:"degrade",recoveryActions:["Continue without saving","Clear extension data","Restart browser"]}],["FAF_1301",{code:"FAF_1301",severity:"critical",message:"Service worker initialization failed",userMessage:"Extension background service failed to start. Please restart the browser.",recoveryStrategy:"restart",recoveryActions:["Restart browser","Reload extension","Check for browser updates"]}],["FAF_1303",{code:"FAF_1303",severity:"medium",message:"Service worker under memory pressure",userMessage:"Extension is using high memory. Performance may be affected.",recoveryStrategy:"degrade",recoveryActions:["Close unused tabs","Restart browser","Limit concurrent extractions"]}],["FAF_1501",{code:"FAF_1501",severity:"medium",message:"Clipboard permission denied",userMessage:"Cannot copy to clipboard automatically. You can copy the content manually.",recoveryStrategy:"fallback",recoveryActions:["Grant clipboard permission","Copy content manually","Use Ctrl+C to copy"]}],["FAF_1503",{code:"FAF_1503",severity:"low",message:"Clipboard data too large",userMessage:"The extracted content is too large for clipboard. Consider extracting smaller sections.",recoveryStrategy:"degrade",recoveryActions:["Extract smaller code sections","Copy parts manually","Save to file instead"]}],["FAF_1703",{code:"FAF_1703",severity:"high",message:"Content Security Policy violation",userMessage:"Page security settings prevent FAF from working. This is common on some secure sites.",recoveryStrategy:"degrade",recoveryActions:["Try on a different page","Use manual copy instead","Contact site administrator"]}],["FAF_1901",{code:"FAF_1901",severity:"medium",message:"An unexpected error occurred",userMessage:"Something unexpected happened. Please try again or restart the browser.",recoveryStrategy:"retry",recoveryActions:["Try the action again","Refresh the page","Restart browser if issues persist"]}]]);static getErrorInfo(e){const t=this.errorDefinitions.get(e);return t||{code:e,severity:"medium",message:"Unknown error",userMessage:"An unknown error occurred. Please try again.",recoveryStrategy:"retry",recoveryActions:["Try again","Restart extension"]}}static getAllErrorCodes(){return Array.from(this.errorDefinitions.keys())}}class I{static async getActive(){return new Promise((e,t)=>{try{chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError){t(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome tabs API operation failed"}));return}const s=r[0];if(!s?.id||!s.url){t(new a(i.CHROME_TAB_NOT_FOUND,"No active tab found",{technicalDetails:"Chrome tabs API operation failed"}));return}e({id:s.id,url:s.url,title:s.title??"",active:s.active})})}catch(r){t(new a(i.CHROME_API_UNAVAILABLE,r instanceof Error?r.message:"Unknown tabs API error",{technicalDetails:"Chrome API operation failed"}))}})}static async sendMessage(e,t){return new Promise((r,s)=>{try{chrome.tabs.sendMessage(e,t,o=>{if(chrome.runtime.lastError){s(new a(i.CHROME_MESSAGE_FAILED,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}r()})}catch(o){s(new a(i.CHROME_API_UNAVAILABLE,o instanceof Error?o.message:"Unknown messaging error",{technicalDetails:"Chrome API operation failed"}))}})}static async executeScript(e,t){return new Promise((r,s)=>{try{chrome.scripting.executeScript({target:{tabId:e},files:[...t]},()=>{if(chrome.runtime.lastError){s(new a(i.CHROME_SCRIPTING_FAILED,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}r()})}catch(o){s(new a(i.CHROME_API_UNAVAILABLE,o instanceof Error?o.message:"Unknown scripting error",{technicalDetails:"Chrome API operation failed"}))}})}}class v{static async get(e){return new Promise((t,r)=>{try{chrome.storage.local.get([...e],s=>{if(chrome.runtime.lastError){r(new a(i.CHROME_STORAGE_ERROR,chrome.runtime.lastError.message||"Unknown storage error",{technicalDetails:"Chrome API operation failed"}));return}t(s)})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown storage error",{technicalDetails:"Chrome API operation failed"}))}})}static async set(e){return new Promise((t,r)=>{try{chrome.storage.local.set(e,()=>{if(chrome.runtime.lastError){r(new a(i.CHROME_STORAGE_QUOTA_EXCEEDED,chrome.runtime.lastError.message||"Unknown storage error",{technicalDetails:"Chrome API operation failed"}));return}t()})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown storage error",{technicalDetails:"Chrome API operation failed"}))}})}static async clear(){return new Promise((e,t)=>{try{chrome.storage.local.clear(()=>{if(chrome.runtime.lastError){t(new a(i.CHROME_STORAGE_ERROR,chrome.runtime.lastError.message||"Unknown storage error",{technicalDetails:"Chrome API operation failed"}));return}e()})}catch(r){t(new a(i.CHROME_API_UNAVAILABLE,r instanceof Error?r.message:"Unknown storage error",{technicalDetails:"Chrome API operation failed"}))}})}}class f{static async setBadgeText(e){return new Promise((t,r)=>{try{chrome.action.setBadgeText({text:e},()=>{if(chrome.runtime.lastError){r(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}t()})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown action error",{technicalDetails:"Chrome API operation failed"}))}})}static async setBadgeBackgroundColor(e){return new Promise((t,r)=>{try{chrome.action.setBadgeBackgroundColor({color:e},()=>{if(chrome.runtime.lastError){r(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}t()})}catch(s){r(new a(i.CHROME_API_UNAVAILABLE,s instanceof Error?s.message:"Unknown action error",{technicalDetails:"Chrome API operation failed"}))}})}static async updateBadge(e){const t=e,r=`${t}%`;let s;t>=80?s="#FF6B35":t>=50?s="#5CE1E6":s="#0A0A0A",await Promise.all([f.setBadgeText(r),f.setBadgeBackgroundColor(s)])}}class T{static async create(e,t,r="icon128.png"){return new Promise((s,o)=>{try{chrome.notifications.create({type:"basic",iconUrl:r,title:e,message:t,priority:2},()=>{if(chrome.runtime.lastError){o(new a(i.CHROME_RUNTIME_ERROR,chrome.runtime.lastError.message||"Unknown runtime error",{technicalDetails:"Chrome API operation failed"}));return}s()})}catch(m){o(new a(i.CHROME_API_UNAVAILABLE,m instanceof Error?m.message:"Unknown notification error",{technicalDetails:"Chrome API operation failed"}))}})}}class O{static sendMessage(e){try{chrome.runtime.sendMessage(e)}catch(t){throw new a(i.CHROME_RUNTIME_ERROR,t instanceof Error?t.message:"Unknown runtime error",{technicalDetails:"Chrome API operation failed"})}}static onMessage(e){chrome.runtime.onMessage.addListener(e)}static onInstalled(e){chrome.runtime.onInstalled.addListener(e)}}class C{static onCommand(e){chrome.commands.onCommand.addListener(e)}}var E={};class A{config;sessionId;breadcrumbs=[];performanceBuffer=[];userId;constructor(e){this.config=e,this.sessionId=this.generateSessionId(),this.initializeErrorHandling(),this.initializePerformanceTracking(),this.startPerformanceReporting()}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}initializeErrorHandling(){this.config.enableErrorReporting&&(window.addEventListener("error",e=>{this.reportError(new Error(e.message),{action:"global_error",url:e.filename,line:e.lineno,column:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.reportError(new Error(`Unhandled Promise Rejection: ${e.reason}`),{action:"unhandled_promise_rejection"})}))}initializePerformanceTracking(){this.config.enablePerformanceTracking&&(typeof performance<"u"&&performance.timing&&window.addEventListener("load",()=>{setTimeout(()=>{this.trackPerformanceMetrics()},1e3)}),this.trackExtensionMetrics())}trackExtensionMetrics(){if(chrome?.runtime){const e=performance.now();chrome.runtime.connect({name:"telemetry"});const t=performance.now()-e;this.recordMetric({name:"service_worker_connection_time",value:t,unit:"ms",timestamp:Date.now()})}if(document.readyState==="loading"){const e=performance.now();document.addEventListener("DOMContentLoaded",()=>{const t=performance.now()-e;this.recordMetric({name:"content_script_injection_time",value:t,unit:"ms",timestamp:Date.now()})})}}trackPerformanceMetrics(){const e=performance.timing,t=performance.navigation;if([{name:"dom_content_loaded",value:e.domContentLoadedEventEnd-e.navigationStart,unit:"ms"},{name:"page_load_complete",value:e.loadEventEnd-e.navigationStart,unit:"ms"},{name:"dns_lookup_time",value:e.domainLookupEnd-e.domainLookupStart,unit:"ms"},{name:"tcp_connection_time",value:e.connectEnd-e.connectStart,unit:"ms"}].forEach(s=>{s.value>0&&this.recordMetric({...s,timestamp:Date.now(),metadata:{navigationType:t.type,redirectCount:t.redirectCount}})}),performance.memory){const s=performance.memory;this.recordMetric({name:"memory_used",value:s.usedJSHeapSize,unit:"bytes",timestamp:Date.now()}),this.recordMetric({name:"memory_limit",value:s.jsHeapSizeLimit,unit:"bytes",timestamp:Date.now()})}}startPerformanceReporting(){setInterval(()=>{this.performanceBuffer.length>0&&this.flushPerformanceMetrics()},3e4)}async recordMetric(e){if(this.config.enablePerformanceTracking&&!(Math.random()>this.config.sampleRate)){this.performanceBuffer.push(e);try{const r=(await chrome.storage.local.get("telemetry_metrics")).telemetry_metrics||[];r.push(e),r.length>100&&r.shift(),await chrome.storage.local.set({telemetry_metrics:r})}catch(t){console.warn("Failed to store telemetry metric:",t)}}}async reportError(e,t={}){if(!this.config.enableErrorReporting)return;const r={error:{name:e.name,message:e.message,stack:e.stack||""},context:{userAgent:navigator.userAgent,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,extensionVersion:this.getExtensionVersion(),...t},stackTrace:e.stack||"",breadcrumbs:[...this.breadcrumbs]};try{const o=(await chrome.storage.local.get("telemetry_errors")).telemetry_errors||[];o.push(r),o.length>50&&o.shift(),await chrome.storage.local.set({telemetry_errors:o})}catch(s){console.warn("Failed to store error report:",s)}this.sendErrorReport(r)}async trackUserEvent(e,t={}){if(!this.config.enableUserAnalytics)return;const r={event:e,properties:{...t,extensionVersion:this.getExtensionVersion(),environment:this.config.environment},timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId};try{const o=(await chrome.storage.local.get("telemetry_events")).telemetry_events||[];o.push(r),o.length>200&&o.shift(),await chrome.storage.local.set({telemetry_events:o})}catch(s){console.warn("Failed to store user event:",s)}this.sendUserEvent(r)}async trackExtraction(e,t={}){return this.trackUserEvent(`extraction_${e}`,t)}async track(e,t={}){return this.trackUserEvent(e,t)}addBreadcrumb(e){const t=`${new Date().toISOString()}: ${e}`;this.breadcrumbs.push(t),this.breadcrumbs.length>20&&this.breadcrumbs.shift()}setUserId(e){this.userId=e}async flushPerformanceMetrics(){if(this.performanceBuffer.length===0)return;const e=[...this.performanceBuffer];this.performanceBuffer=[];try{await this.sendBatch("metrics",e)}catch(t){console.warn("Failed to send performance metrics:",t),this.performanceBuffer.unshift(...e)}}async sendErrorReport(e){try{await this.sendBatch("errors",[e])}catch(t){console.warn("Failed to send error report:",t)}}async sendUserEvent(e){try{await this.sendBatch("events",[e])}catch(t){console.warn("Failed to send user event:",t)}}async sendBatch(e,t){if(!this.config.endpoint)return;const r={type:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,environment:this.config.environment},s=await fetch(`${this.config.endpoint}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`)}getExtensionVersion(){try{return chrome.runtime.getManifest().version}catch{return"unknown"}}startTimer(e){const t=performance.now();return()=>{const r=performance.now()-t;this.recordMetric({name:e,value:r,unit:"ms",timestamp:Date.now()})}}trackMemoryUsage(e){if(performance.memory){const t=performance.memory;this.recordMetric({name:"memory_usage_snapshot",value:t.usedJSHeapSize,unit:"bytes",timestamp:Date.now(),metadata:{context:e}})}}trackNetworkRequest(e,t,r,s){this.recordMetric({name:"network_request",value:r,unit:"ms",timestamp:Date.now(),metadata:{url:e.replace(/[?#].*/,""),method:t,status:s,success:s>=200&&s<400}})}}const R=()=>{const e={environment:"production",enableErrorReporting:!0,enablePerformanceTracking:!0,enableUserAnalytics:!0,sampleRate:.1,endpoint:E.TELEMETRY_ENDPOINT};return new A(e)},M=async(n,e)=>{const t=h.startTimer(n);try{const r=await e();return t(),r}catch(r){throw t(),r}},h=R(),w={maxAttempts:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2,timeout:3e4};class y{static instance=null;retryAttempts=new Map;retryTimers=new Map;static getInstance(){return y.instance||(y.instance=new y),y.instance}async withRecovery(e,t){const{operationId:r,context:s="unknown"}=t,o={...w,...t.retryConfig};let m=null;const g=Date.now();this.clearRetryTimer(r);for(let c=1;c<=o.maxAttempts;c++)try{if(o.timeout&&Date.now()-g>o.timeout)throw new a(i.EXTRACTION_TIMEOUT,"Operation timeout exceeded",{context:{timestamp:Date.now()}});const l=await this.executeWithTimeout(e,o.timeout);return this.retryAttempts.delete(r),c>1&&h.track("error_boundary",{type:"recovery_success",operationId:r,context:s,attemptsRequired:c,duration:Date.now()-g}),l}catch(l){if(m=l instanceof a?l:a.fromUnknown(l,{timestamp:Date.now()}),console.warn(`[${s}] Attempt ${c}/${o.maxAttempts} failed:`,{error:m.code,message:m.message,severity:m.severity}),this.retryAttempts.set(r,c),!this.shouldRetry(m,c,o.maxAttempts))break;const p=this.calculateDelay(c,o);c<o.maxAttempts&&await this.delay(p)}if(t.fallbackOperation)try{console.log(`[${s}] Trying fallback operation after ${o.maxAttempts} failed attempts`);const c=await t.fallbackOperation();return h.track("error_boundary",{type:"fallback_success",operationId:r,context:s,originalError:m?.code,duration:Date.now()-g}),c}catch(c){const l=c instanceof a?c:a.fromUnknown(c,{timestamp:Date.now()});if(h.track("error_boundary",{type:"fallback_failed",operationId:r,context:s,originalError:m?.code,fallbackError:l.code,duration:Date.now()-g}),this.compareSeverity(l.severity,m?.severity||d.LOW)>=0)throw l}throw this.retryAttempts.delete(r),h.track("error_boundary",{type:"recovery_failed",operationId:r,context:s,finalError:m?.code,attemptsUsed:o.maxAttempts,duration:Date.now()-g}),m||new a(i.UNKNOWN_ERROR,"Operation failed after all recovery attempts")}async handleError(e,t){const r=e instanceof a?e:a.fromUnknown(e);switch(h.track("error_boundary",{type:"error_handled",operationId:t.operationId,operationType:t.operationType,errorCode:r.code,severity:r.severity,recoveryStrategy:r.recoveryStrategy}),r.recoveryStrategy){case u.RETRY:return{recovered:!1,suggestion:"This issue is usually temporary. Try the operation again.",actions:["Retry now","Wait 30 seconds and retry","Refresh page and retry"]};case u.FALLBACK:return{recovered:await this.attemptFallbackRecovery(r,t),suggestion:"Switched to alternative method due to the issue.",actions:["Continue with limited functionality","Try full operation later","Check settings"]};case u.GRACEFUL_DEGRADATION:return{recovered:!0,suggestion:"Continuing with reduced functionality to work around the issue.",actions:["Continue anyway","Try on different page","Report issue"]};case u.USER_ACTION_REQUIRED:return{recovered:!1,suggestion:"User action is required to resolve this issue.",actions:r.recoveryActions};case u.RESTART_REQUIRED:return{recovered:!1,suggestion:"Extension restart is required to fix this issue.",actions:["Restart browser","Reload extension","Check for updates"]};default:return{recovered:!1,suggestion:"This error requires manual resolution.",actions:["Try again later","Check browser console","Report issue"]}}}getRetryCount(e){return this.retryAttempts.get(e)||0}clearRetryState(e){this.retryAttempts.delete(e),this.clearRetryTimer(e)}getRecoveryRecommendations(e){const t=e instanceof a?e:a.fromUnknown(e);switch(this.categorizeError(t.code)){case"platform":return{immediate:["Refresh the page","Wait for page to fully load","Try on supported platform"],followUp:["Check internet connection","Clear browser cache","Update browser"],prevention:["Use supported development platforms","Ensure stable internet connection"]};case"permissions":return{immediate:["Check extension permissions","Grant required permissions","Reload extension"],followUp:["Restart browser","Reinstall extension if needed"],prevention:["Keep extension permissions up to date","Avoid revoking permissions"]};case"performance":return{immediate:["Close unused tabs","Wait and retry","Reduce complexity"],followUp:["Restart browser","Check system resources"],prevention:["Limit concurrent operations","Use smaller code sections"]};case"network":return{immediate:["Check internet connection","Retry in a moment","Try different network"],followUp:["Clear browser cache","Disable VPN if used"],prevention:["Use stable internet connection","Avoid peak usage times"]};default:return{immediate:t.recoveryActions,followUp:["Restart browser","Check for updates"],prevention:["Keep extension updated","Use supported browsers"]}}}async executeWithTimeout(e,t){return t?Promise.race([e(),new Promise((r,s)=>{setTimeout(()=>{s(new a(i.EXTRACTION_TIMEOUT,`Operation timed out after ${t}ms`))},t)})]):e()}shouldRetry(e,t,r){return t>=r||e.severity===d.CRITICAL||e.recoveryStrategy===u.USER_ACTION_REQUIRED||e.recoveryStrategy===u.NO_RECOVERY?!1:![i.CHROME_PERMISSIONS_MISSING,i.PLATFORM_NOT_SUPPORTED,i.CONTENT_SCRIPT_CSP_VIOLATION].includes(e.code)}calculateDelay(e,t){const r=t.baseDelay*Math.pow(t.backoffFactor,e-1),s=Math.random()*.1*r;return Math.min(r+s,t.maxDelay)}async delay(e){return new Promise(t=>setTimeout(t,e))}clearRetryTimer(e){const t=this.retryTimers.get(e);t&&(clearTimeout(t),this.retryTimers.delete(e))}compareSeverity(e,t){const r=[d.LOW,d.MEDIUM,d.HIGH,d.CRITICAL];return r.indexOf(e)-r.indexOf(t)}async attemptFallbackRecovery(e,t){switch(e.code){case i.CLIPBOARD_PERMISSION_DENIED:return!0;case i.PLATFORM_DOM_ACCESS_DENIED:return!1;case i.CHROME_STORAGE_QUOTA_EXCEEDED:try{return!0}catch{return!1}default:return!1}}categorizeError(e){return e.includes("PLATFORM")?"platform":e.includes("PERMISSION")||e.includes("ACCESS")?"permissions":e.includes("TIMEOUT")||e.includes("MEMORY")||e.includes("QUOTA")?"performance":e.includes("NETWORK")||e.includes("REQUEST")?"network":"unknown"}}const F=y.getInstance();export{T as C,a as F,d as a,i as b,O as c,C as d,F as e,f,I as g,v as h,M as i,h as t};
